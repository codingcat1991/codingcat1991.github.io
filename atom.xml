<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>写程序的猫</title>
  
  
  <link href="http://blog.codingcat.net/atom.xml" rel="self"/>
  
  <link href="http://blog.codingcat.net/"/>
  <updated>2022-01-01T14:32:15.498Z</updated>
  <id>http://blog.codingcat.net/</id>
  
  <author>
    <name>CodingCat</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Python生成公共包（SDK）</title>
    <link href="http://blog.codingcat.net/2021/12/28/Python%E7%94%9F%E6%88%90%E5%85%AC%E5%85%B1%E5%8C%85%EF%BC%88SDK%EF%BC%89/"/>
    <id>http://blog.codingcat.net/2021/12/28/Python%E7%94%9F%E6%88%90%E5%85%AC%E5%85%B1%E5%8C%85%EF%BC%88SDK%EF%BC%89/</id>
    <published>2021-12-28T12:28:17.000Z</published>
    <updated>2022-01-01T14:32:15.498Z</updated>
    
    <content type="html"><![CDATA[<p>很多时候我们希望将开发的模块代码弄成公用的模块，方便各个开发人员使用，那应该怎么做呢？</p><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>使用如下项目演示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python-sdk</span><br><span class="line">    │  README.md</span><br><span class="line">    │  setup.py</span><br><span class="line">    │</span><br><span class="line">    └─Demo</span><br><span class="line">            __init__.py</span><br></pre></td></tr></table></figure><p>其中Demo中只有一个方法，写在__init__.py模块中，如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span>():</span></span><br><span class="line">    print(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>setup.py用于安装Demo包，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"> </span><br><span class="line">setup(</span><br><span class="line">name = <span class="string">&quot;demo&quot;</span>,</span><br><span class="line">version = <span class="string">&quot;0.1&quot;</span>,</span><br><span class="line">url = <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">long_description = <span class="built_in">open</span>(<span class="string">&#x27;README.md&#x27;</span>).read(),</span><br><span class="line">packages = find_packages(),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>各参数含义如下：</p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>name</td><td>包的名字</td></tr><tr><td>version</td><td>版本号，对保持适当的依赖关系很重要</td></tr><tr><td>packages</td><td>需要包含的子包列表，用find_packages()查找</td></tr><tr><td>url</td><td>包的链接，通常为 Github 上的链接，或者是 readthedocs 链接</td></tr><tr><td>long_description</td><td>将说明文件设置为README.md</td></tr></tbody></table><h2 id="创建包"><a href="#创建包" class="headerlink" title="创建包"></a>创建包</h2><p>执行<code>python setup.py bdist_egg</code>即可将Demo打包的一个SKD包，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxx\Desktop\python-sdk&gt;python setup.py bdist_egg</span><br><span class="line">running bdist_egg</span><br><span class="line">running egg_info</span><br><span class="line">creating demo.egg-info</span><br><span class="line">writing demo.egg-info\PKG-INFO</span><br><span class="line">writing dependency_links to demo.egg-info\dependency_links.txt</span><br><span class="line">writing top-level names to demo.egg-info\top_level.txt</span><br><span class="line">writing manifest file &#39;demo.egg-info\SOURCES.txt&#39;</span><br><span class="line">reading manifest file &#39;demo.egg-info\SOURCES.txt&#39;</span><br><span class="line">writing manifest file &#39;demo.egg-info\SOURCES.txt&#39;</span><br><span class="line">installing library code to build\bdist.win-amd64\egg</span><br><span class="line">running install_lib</span><br><span class="line">running build_py</span><br><span class="line">creating build</span><br><span class="line">creating build\lib</span><br><span class="line">creating build\lib\Demo</span><br><span class="line">copying Demo\__init__.py -&gt; build\lib\Demo</span><br><span class="line">creating build\bdist.win-amd64</span><br><span class="line">creating build\bdist.win-amd64\egg</span><br><span class="line">creating build\bdist.win-amd64\egg\Demo</span><br><span class="line">copying build\lib\Demo\__init__.py -&gt; build\bdist.win-amd64\egg\Demo</span><br><span class="line">byte-compiling build\bdist.win-amd64\egg\Demo\__init__.py to __init__.cpython-37.pyc</span><br><span class="line">creating build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\PKG-INFO -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\SOURCES.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\dependency_links.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\top_level.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">zip_safe flag not set; analyzing archive contents...</span><br><span class="line">creating dist</span><br><span class="line">creating &#39;dist\demo-0.1-py3.7.egg&#39; and adding &#39;build\bdist.win-amd64\egg&#39; to it</span><br><span class="line">removing &#39;build\bdist.win-amd64\egg&#39; (and everything under it)</span><br></pre></td></tr></table></figure><p>执行后，python-sdk目录下多了build、dist、demo.egg-info三个文件夹，目录结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">─python-sdk</span><br><span class="line">    │  README.md</span><br><span class="line">    │  setup.py</span><br><span class="line">    │</span><br><span class="line">    ├─build</span><br><span class="line">    │  ├─bdist.win-amd64</span><br><span class="line">    │  └─lib</span><br><span class="line">    │      └─Demo</span><br><span class="line">    │              __init__.py</span><br><span class="line">    │</span><br><span class="line">    ├─Demo</span><br><span class="line">    │      __init__.py</span><br><span class="line">    │</span><br><span class="line">    ├─demo.egg-info</span><br><span class="line">    │      dependency_links.txt</span><br><span class="line">    │      PKG-INFO</span><br><span class="line">    │      SOURCES.txt</span><br><span class="line">    │      top_level.txt</span><br><span class="line">    │</span><br><span class="line">    └─dist</span><br><span class="line">            demo-0.1-py3.7.egg</span><br></pre></td></tr></table></figure><p>将python-sdk下面的文件都打包到一个压缩包里面，就可以发给其他人使用了</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>将受到的压缩包解压，并进入到包含setup.py所在的目录，执行如下命令安装包：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><p>安装过程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxx\Desktop\python-sdk&gt;python setup.py install</span><br><span class="line">running install</span><br><span class="line">running bdist_egg</span><br><span class="line">running egg_info</span><br><span class="line">writing demo.egg-info\PKG-INFO</span><br><span class="line">writing dependency_links to demo.egg-info\dependency_links.txt</span><br><span class="line">writing top-level names to demo.egg-info\top_level.txt</span><br><span class="line">reading manifest file &#39;demo.egg-info\SOURCES.txt&#39;</span><br><span class="line">writing manifest file &#39;demo.egg-info\SOURCES.txt&#39;</span><br><span class="line">installing library code to build\bdist.win-amd64\egg</span><br><span class="line">running install_lib</span><br><span class="line">running build_py</span><br><span class="line">creating build\bdist.win-amd64\egg</span><br><span class="line">creating build\bdist.win-amd64\egg\Demo</span><br><span class="line">copying build\lib\Demo\__init__.py -&gt; build\bdist.win-amd64\egg\Demo</span><br><span class="line">byte-compiling build\bdist.win-amd64\egg\Demo\__init__.py to __init__.cpython-37.pyc</span><br><span class="line">creating build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\PKG-INFO -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\SOURCES.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\dependency_links.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">copying demo.egg-info\top_level.txt -&gt; build\bdist.win-amd64\egg\EGG-INFO</span><br><span class="line">zip_safe flag not set; analyzing archive contents...</span><br><span class="line">creating &#39;dist\demo-0.1-py3.7.egg&#39; and adding &#39;build\bdist.win-amd64\egg&#39; to it</span><br><span class="line">removing &#39;build\bdist.win-amd64\egg&#39; (and everything under it)</span><br><span class="line">Processing demo-0.1-py3.7.egg</span><br><span class="line">Removing e:\app\python\python37\lib\site-packages\demo-0.1-py3.7.egg</span><br><span class="line">Copying demo-0.1-py3.7.egg to e:\app\python\python37\lib\site-packages</span><br><span class="line">demo 0.1 is already the active version in easy-install.pth</span><br><span class="line"></span><br><span class="line">Installed e:\app\python\python37\lib\site-packages\demo-0.1-py3.7.egg</span><br><span class="line">Processing dependencies for demo&#x3D;&#x3D;0.1</span><br><span class="line">Finished processing dependencies for demo&#x3D;&#x3D;0.1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>进入到Python解释器并执行包中的函数如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxx\Desktop\python-sdk&gt;python</span><br><span class="line">Python 3.7.5 (tags&#x2F;v3.7.5:5c02a39a0b, Oct 15 2019, 00:11:34) [MSC v.1916 64 bit (AMD64)] on win32</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import Demo</span><br><span class="line">&gt;&gt;&gt; Demo.say_hello()</span><br><span class="line">hello!</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>卸载包使用<code>pip uninstall</code>命令即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxx\Desktop\python-sdk&gt;pip uninstall Demo</span><br><span class="line">Found existing installation: Demo 0.1</span><br><span class="line">Uninstalling demo-0.1:</span><br><span class="line">  Would remove:</span><br><span class="line">    e:\app\python\python37\lib\site-packages\demo-0.1-py3.7.egg</span><br><span class="line">Proceed (y&#x2F;n)? y</span><br><span class="line">  Successfully uninstalled bscp-config-0.1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">很多时候我们希望将开发的模块代码弄成公用的模块，方便各个开发人员使用，那应该怎么做呢？</summary>
    
    
    
    <category term="Python" scheme="http://blog.codingcat.net/categories/Python/"/>
    
    
    <category term="Python" scheme="http://blog.codingcat.net/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>使用码云自动化部署应用</title>
    <link href="http://blog.codingcat.net/2021/12/06/%E4%BD%BF%E7%94%A8%E7%A0%81%E4%BA%91%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/"/>
    <id>http://blog.codingcat.net/2021/12/06/%E4%BD%BF%E7%94%A8%E7%A0%81%E4%BA%91%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/</id>
    <published>2021-12-06T07:59:44.000Z</published>
    <updated>2022-01-01T14:32:15.501Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>我们在做一些小型的网站开发的时候，希望能够在将代码推送到仓库后，能够实现自动部署。</p><p>本文介绍在使用hexo构建自己博客的时候，使用码云作为代码仓库，阿里云CentOS7服务器作为部署应用部署服务器来提供服务，使用码云提供的WebHook功能，如何实现在每次提交代码后能够自动打包，自动部署。</p><h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="配置公钥"><a href="#配置公钥" class="headerlink" title="配置公钥"></a>配置公钥</h3><ol><li><p>生成</p><p>执行如下代码，三次回车后会生成公钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;git@gitee.com&quot; </span><br></pre></td></tr></table></figure></li><li><p>查看公钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ~&#x2F;.ssh&#x2F;id_rsa.pub</span><br></pre></td></tr></table></figure><p><img src="image-20211206161301912.png" alt="image-20211206161301912"></p></li><li><p>添加公钥</p><p><img src="image-20211206160759969.png" alt="image-20211206160759969"></p><p><img src="image-20211206160843863.png" alt="image-20211206160843863"></p><p>标题可以自定义公钥部分输入步骤2查看得到的结果，点击添加即可</p></li><li><p>测试</p><p>在部署服务器上执行下面代码。输出如图表示已配置成功。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@gitee.com</span><br></pre></td></tr></table></figure></li></ol><p><img src="image-20211206161152973.png" alt="image-20211206161152973"></p><h3 id="创建wehook服务"><a href="#创建wehook服务" class="headerlink" title="创建wehook服务"></a>创建wehook服务</h3><ol><li><p>安装node环境</p><p>略</p></li><li><p>初始化node引用</p><p>切换到node应用目录，执行下面脚本，一路回车即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm ini</span><br></pre></td></tr></table></figure><p><img src="image-20211206161706814.png" alt="image-20211206161706814"></p></li><li><p>安装插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install  gitee-webhook-handler --save</span><br></pre></td></tr></table></figure><p><img src="image-20211206161903300.png" alt="image-20211206161903300"></p></li><li><p>创建服务脚本</p><p>新增index.js文件，内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> createHandler = <span class="built_in">require</span>(<span class="string">&#x27;gitee-webhook-handler&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> handler = createHandler(&#123; <span class="attr">path</span>: <span class="string">&#x27;/webhooks_push&#x27;</span>, <span class="attr">secret</span>: <span class="string">&#x27;123456&#x27;</span> &#125;)   <span class="comment">// webhookpost路径及密码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run_cmd</span>(<span class="params">cmd, args, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> spawn = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).spawn;</span><br><span class="line">  <span class="keyword">var</span> child = spawn(cmd, args);</span><br><span class="line">  <span class="keyword">var</span> resp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  child.stdout.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">buffer</span>) </span>&#123; resp += buffer.toString(); &#125;);</span><br><span class="line">  child.stdout.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; callback (resp) &#125;);</span><br><span class="line">&#125;</span><br><span class="line">handler.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">&#x27;Error:&#x27;</span>, err.message)</span><br><span class="line">&#125;)</span><br><span class="line">handler.on(<span class="string">&#x27;Push Hook&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Received a push event for %s to %s&#x27;</span>, event.payload.repository.name,event.payload.ref);</span><br><span class="line">  run_cmd(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;./deploy.sh&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123; <span class="built_in">console</span>.log(text) &#125;); <span class="comment">//部署脚本文件路径</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    handler(req, res, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      res.statusCode = <span class="number">404</span></span><br><span class="line">      res.end(<span class="string">&#x27;no such location&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;).listen(<span class="number">83</span>) <span class="comment">//服务监听端口</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">&#x27;Error:&#x27;</span>, err.message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建部署脚本</p><p>部署脚本根据自己的需求创建，下图是我自己写的hexo博客的简单部署脚本</p><p><img src="image-20211206162433796.png" alt="image-20211206162433796"></p></li><li><p>启动node服务</p><p>执行下面命令即可启动服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js </span><br></pre></td></tr></table></figure></li><li><p>码云添加WebHook服务</p><p><img src="image-20211206162611806.png" alt="image-20211206162611806"></p><p>URL填写上面启动服务后的地址，如我的是<a href="http://xx.xx.xx.xx:83/webhooks_push">http://xx.xx.xx.xx:83/webhooks_push</a></p><p>WebHook密码/签名密钥填写服务脚本里面写的密码，如我的是：123456</p></li><li><p>测试服务</p><p><img src="image-20211206163253121.png" alt="image-20211206163253121"></p><p>对应的日志输出：</p><p><img src="image-20211206163208246.png" alt="image-20211206163208246"></p></li><li><p>提交代码实现自动部署</p><p>将代码推送到仓库可以看到对应的部署日志，且新增的文章已可以查阅。</p><p><img src="image-20211206164809814.png" alt="image-20211206164809814"></p></li></ol>]]></content>
    
    
    <summary type="html">本文介绍在使用hexo构建自己博客的时候，使用码云作为代码仓库，阿里云CentOS7服务器作为部署应用部署服务器来提供服务，使用码云提供的WebHook功能，如何实现在每次提交代码后能够自动打包，自动部署。</summary>
    
    
    
    <category term="运维" scheme="http://blog.codingcat.net/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="运维" scheme="http://blog.codingcat.net/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>活着：现实与意义</title>
    <link href="http://blog.codingcat.net/2021/10/21/%E6%B4%BB%E7%9D%80%EF%BC%9A%E7%8E%B0%E5%AE%9E%E4%B8%8E%E6%84%8F%E4%B9%89/"/>
    <id>http://blog.codingcat.net/2021/10/21/%E6%B4%BB%E7%9D%80%EF%BC%9A%E7%8E%B0%E5%AE%9E%E4%B8%8E%E6%84%8F%E4%B9%89/</id>
    <published>2021-10-21T12:02:17.000Z</published>
    <updated>2022-01-01T14:32:15.512Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、脑图"><a href="#一、脑图" class="headerlink" title="一、脑图"></a>一、脑图</h1><p><img src="%E6%B4%BB%E7%9D%80.png"></p><p><a href="%E6%B4%BB%E7%9D%80.xmind">下载Xmind脑图</a></p><h1 id="二、摘录"><a href="#二、摘录" class="headerlink" title="二、摘录"></a>二、摘录</h1><p>人是为活着本身而活着的，而不是为活着之外的任何事物所活着</p><p>做人呵，一旦嫖上以后，也就免不了要去赌。这个嫖和赌，就像是胳膊和肩膀连在一起，怎么都分不开。</p><p>人只要活得高兴，穷也不怕。</p><p>人要是累得整天没力气，就不会去乱想了。</p><p>只要想着自己不死，就死不了。</p><p>我全身都是越来越硬，只有一个地方越来越软。</p><p>做人不能忘记四条，话不要说错，床不要睡错，门槛不要踏错，口袋不要摸错。</p><p>人老了也是人，是人就得干净一些。</p><p>死人都还想活过来，你一个大活人可不能去死。</p><p>你的命是爹娘给的，你不要命了也得先去问问他们。</p><p>一个人命再大，要是自己想死，那就怎么也活不了。</p><p>我也想不到，先前最怕的就是我和家珍死了凤霞怎么办，你娶了凤霞，我们心就定了，有了孩子更好了，凤霞以后死了也有人收作。</p><p>人啊，活着时受了再多的苦，到了快死的时候也会想个法子来宽慰自己，</p><p>葬，全是我亲手埋的，到了有一天我腿一伸，也不用担心谁了。我也想通了，轮到自己死时，安安心心死就是，不用盼着收尸的人，村里肯定会有人来埋我的，要不我人一臭，那气味谁也受不了。我不会让别人白白埋我的，我在枕头底下压了十元钱，这十元钱我饿死也不会去动它的，村里人都知道这十元钱是给替我收尸的那个人，他们也都知道我死后是要和家珍他们埋在一起的。</p><p>做人还是平常点好，争这个争那个，争来争去赔了自己的命。像我这样，说起来是越混越没出息，可寿命长，我认识的人一个挨着一个死去，我还活着。</p><p>想想做牛真是可怜。累死累活替人干了一辈子，老了，力气小了，就要被人宰了吃掉。</p><h1 id="三、感想"><a href="#三、感想" class="headerlink" title="三、感想"></a>三、感想</h1><p>人活着是没有意义的，或者说人活着的意义就是活着本身。<br>没有必须要去死的理由，那就好好的活着，活着或许没有意义，但是死亡也不见得有意义？<br>人们每天都做着重复的事情，每一代的人都重复着上一代人的路途。但是既然活着，又何必急着去死？<br>谁又能确定自己是活着的？</p>]]></content>
    
    
    <summary type="html">人是为活着本身而活着的，而不是为活着之外的任何事物所活着</summary>
    
    
    
    <category term="读书笔记" scheme="http://blog.codingcat.net/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="读书笔记" scheme="http://blog.codingcat.net/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>股票盈利宝典：强庄股买卖</title>
    <link href="http://blog.codingcat.net/2021/09/29/%E8%82%A1%E7%A5%A8%E7%9B%88%E5%88%A9%E5%AE%9D%E5%85%B8%EF%BC%9A%E5%BC%BA%E5%BA%84%E8%82%A1%E4%B9%B0%E5%8D%96/"/>
    <id>http://blog.codingcat.net/2021/09/29/%E8%82%A1%E7%A5%A8%E7%9B%88%E5%88%A9%E5%AE%9D%E5%85%B8%EF%BC%9A%E5%BC%BA%E5%BA%84%E8%82%A1%E4%B9%B0%E5%8D%96/</id>
    <published>2021-09-28T22:43:50.000Z</published>
    <updated>2022-01-01T14:32:15.515Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、神奇的趋势线"><a href="#一、神奇的趋势线" class="headerlink" title="一、神奇的趋势线"></a>一、神奇的趋势线</h2><ul><li>神奇的趋势线：144均线</li><li>顺势而为：在大版上涨趋势中去找做符合144均线以上股票，（能做到这一点就已经超越了60%的散户）当然144均线以上知识其中的一个条件，还需要配合量能、筹码等知识。</li></ul><h2 id="二、主力成交量技术"><a href="#二、主力成交量技术" class="headerlink" title="二、主力成交量技术"></a>二、主力成交量技术</h2><ul><li>有效跌破：跌破后的连续三个交易日的收盘价在支撑位下方</li><li>有效突破：突破后的连续3个交易日的收盘价在压力位上方</li><li>压力位、支撑位：根据经验选择</li><li>成交量：指一个时间单位内对某项交易成交的数量（单位：手）</li><li>成交额：成交量*100*成交价格</li><li>成交量就是真金白银、交易活跃程度</li><li>成交量放大（放量）：主力是可以做出来的，倒手活着大量买入</li><li>成交量放大（缩量）：主力是不能控制的，主力自己不买卖，不能控制别的投资者买卖</li><li>成交量120日均量是重要的参考标志，交易活跃。大部分强势股都是交易活跃</li></ul><h2 id="三、主力筹码技术"><a href="#三、主力筹码技术" class="headerlink" title="三、主力筹码技术"></a>三、主力筹码技术</h2><ul><li>筹码：流通盘固定，但是持有股票人的买入价格不一样，所以持有者筹码价格不一样<ul><li>能有效识别主力建仓和派发全过程</li><li>能分辨支撑位和压力位</li><li>判断成交密集区和筹码分布变化</li></ul></li><li>主力不愿意拉升的筹码形态<ul><li>大量的套牢筹码</li><li>筹码分布极其不均匀</li></ul></li></ul><h2 id="四、识别主力手法"><a href="#四、识别主力手法" class="headerlink" title="四、识别主力手法"></a>四、识别主力手法</h2><p><img src="%E8%AF%86%E5%88%AB%E4%B8%BB%E5%8A%9B%E6%89%8B%E6%B3%95.png"></p><h2 id="五、主力诱导手法"><a href="#五、主力诱导手法" class="headerlink" title="五、主力诱导手法"></a>五、主力诱导手法</h2><ul><li>名博、新闻、媒体上看到的优质股票消息，大部分都是诱导</li><li>主力出货无非就是诱导你进场</li><li>主力诱导手法：<ul><li>主力提前画瓢，让你看出所谓的“规律”</li><li>创新高诱导</li></ul></li></ul><h2 id="六、短线强庄股"><a href="#六、短线强庄股" class="headerlink" title="六、短线强庄股"></a>六、短线强庄股</h2><ul><li>你是如何买股票的？<ul><li>抄底（很容易操在半山腰）</li><li>最高（很容易被套）</li><li>买低位横盘股</li></ul></li><li>短线强庄股特点<ul><li>股价站稳144均线上方</li><li>有连续的3个交易提成交量在120日均线以上</li><li>套牢筹码不能大于80%</li><li>前期有下跌过的（不是在高位）</li><li>流通值小于100亿</li></ul></li></ul><h2 id="七、短线强庄股初选"><a href="#七、短线强庄股初选" class="headerlink" title="七、短线强庄股初选"></a>七、短线强庄股初选</h2><ul><li>下午15:00后抽时间复盘</li><li>初步选出短线强庄股（按涨幅从高到低排序）</li></ul><h2 id="八、强庄股买卖点"><a href="#八、强庄股买卖点" class="headerlink" title="八、强庄股买卖点"></a>八、强庄股买卖点</h2><ul><li><p>选出完全符合短线强庄股特点的个股</p></li><li><p>剔除新股和ST股</p></li><li><p>提出突破144均线后涨幅超过20%的个股</p></li><li><p>剔除走势紊乱的个股</p></li><li><p>大盘处于震荡行情活着上涨行情（最好上涨行情）</p></li><li><p>符合条件的个股最好是属于热门题材的个股</p></li><li><p>买入时机最好是在5日均线附近</p></li><li><p>利润在5到15个点左右可以考虑卖出</p></li><li><p>不破5日线不出</p></li><li><p>结合前期高点压力位置卖出</p></li></ul>]]></content>
    
    
    <summary type="html">《股票盈利宝典》视频教程学习笔记</summary>
    
    
    
    <category term="股票" scheme="http://blog.codingcat.net/categories/%E8%82%A1%E7%A5%A8/"/>
    
    
    <category term="股票" scheme="http://blog.codingcat.net/tags/%E8%82%A1%E7%A5%A8/"/>
    
  </entry>
  
  <entry>
    <title>西西弗神话：去活还是去死</title>
    <link href="http://blog.codingcat.net/2021/09/07/%E8%A5%BF%E8%A5%BF%E5%BC%97%E7%A5%9E%E8%AF%9D%EF%BC%9A%E5%8E%BB%E6%B4%BB%E8%BF%98%E6%98%AF%E5%8E%BB%E6%AD%BB/"/>
    <id>http://blog.codingcat.net/2021/09/07/%E8%A5%BF%E8%A5%BF%E5%BC%97%E7%A5%9E%E8%AF%9D%EF%BC%9A%E5%8E%BB%E6%B4%BB%E8%BF%98%E6%98%AF%E5%8E%BB%E6%AD%BB/</id>
    <published>2021-09-07T04:47:52.000Z</published>
    <updated>2022-01-01T14:32:15.518Z</updated>
    
    <content type="html"><![CDATA[<p>真正严肃的哲学问题只有一个，那便是自杀。判断人生值不值得活，等于回答哲学的根本问题。</p><p>不过有一天，“为什么”的疑问油然而生，于是一切就在这种略带惊讶的百无聊赖中开始了。厌倦处在机械生活的末端，但又是开启意识活动的序幕：唤醒意识，触发未来。未来，要么在循环中无意识的返回，要么彻底清醒。觉醒之后，久而久之，所得的结果，要么自杀，要么康复。</p>]]></content>
    
    
    <summary type="html">活着有什么意义？</summary>
    
    
    
    <category term="读书笔记" scheme="http://blog.codingcat.net/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="读书笔记" scheme="http://blog.codingcat.net/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>MySQL性能优化：回表、覆盖索引及索引下推优化</title>
    <link href="http://blog.codingcat.net/2021/07/15/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%9A%E5%9B%9E%E8%A1%A8%E3%80%81%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E5%8F%8A%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8%E4%BC%98%E5%8C%96/"/>
    <id>http://blog.codingcat.net/2021/07/15/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%9A%E5%9B%9E%E8%A1%A8%E3%80%81%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E5%8F%8A%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8%E4%BC%98%E5%8C%96/</id>
    <published>2021-07-15T01:29:29.000Z</published>
    <updated>2022-01-01T14:32:15.493Z</updated>
    
    <content type="html"><![CDATA[<p>索引就像书的目录一样，可以帮助数据库快速定位到数据所在的位置。</p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>MySQL中，InnoDB存储引擎的索引使用B+数数据结构实现，具体结构如下：</p><p><img src="InnoDB%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84.png" alt="InnoDB索引结构"></p><p>有以下特点：</p><ul><li>数据文件本身就是索引文件</li><li>数据按照主键顺序组织和存储，因此InnoDB要求表必须有主键，如果没有指定主键或唯一键，则自动生成一个长度为6个字节的隐式长整型字段来作为主键，主键索引称聚簇索引</li><li>所以非主键索引的数据域都会存储主键ID，除了联合索引外，其他的耳机索引的数据域存储的就是主键ID</li><li>使用主键搜索数据非常高效，但是使用其他索引有可能会需要回表</li></ul><h2 id="回表"><a href="#回表" class="headerlink" title="回表"></a>回表</h2><p>在使用主键查询的时候，由于主键索引上的数据域存储了该条数据的完整内容，所以能够直接将数据取出来。但是当使用非主键索引，如二级索引查询数据时，索引上数据域只存储了该条数据对应的主键，为了拿到完整的数据，还需要使用主键的值回到表中去查询数据，这个过程就称为回表。在InnoDB中，除非索引上已经包含了查询所需要的完整数据，否则都会使用ID进行回表查询。</p><h2 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h2><p>在InnoDB中，创建索引可以包含多个字段，比如（name, age），这种索引叫做联合索引。联合索引中，当索引的字段中已经完全包含需要的字段时，就叫做覆盖索引。覆盖索引在查询的时候，因为数据域的字段已经满足查询要求，因此不会回表，减少了一般索引的回表操作，提高查询的性能。不过索引所占用的空间就变大了，属于是以空间换时间的类型。</p><h2 id="索引下推优化"><a href="#索引下推优化" class="headerlink" title="索引下推优化"></a>索引下推优化</h2><p>索引下推，英文Index condition pushdown，简称ICP，是在MySQL5.6退出的特性，和覆盖索引一样，也是用来优化查询的。且索引下推优化只对联合索引才会有效。</p><p>考虑这样一个场景：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_test <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;J%&#x27;</span> <span class="keyword">and</span> age <span class="operator">&gt;</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>假设在表上存在(name, age)这样一个联合索引，在5.6之前，存储引擎根据索引查找到name以J开头的数据后将数据返回给MySQL服务器，服务器判断数据是否符合条件。在5.6之后，因为使用了索引下推优化，MySQL服务器将查询数据的条件发送给InnoDB存储引擎，存储引擎会判断数据是否符合条件，然后检索出数据，将符合条件的数据返回给MySQL服务器。也就是说在判断了name以J开头的数据之后，还会在继续判断age是否大于10，最后再将符合条件的数据返回给MySQL服务器。索引下推减少了回表的次数，也减少了MySQL服务器从存储引擎接收数据的次数或者大小。</p>]]></content>
    
    
    <summary type="html">索引就像书的目录一样，可以帮助数据库快速定位到数据所在的位置。</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="索引" scheme="http://blog.codingcat.net/tags/%E7%B4%A2%E5%BC%95/"/>
    
    <category term="性能优化" scheme="http://blog.codingcat.net/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>MySQL查询未区分大小写</title>
    <link href="http://blog.codingcat.net/2021/07/05/MySQL%E6%9F%A5%E8%AF%A2%E6%9C%AA%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99/"/>
    <id>http://blog.codingcat.net/2021/07/05/MySQL%E6%9F%A5%E8%AF%A2%E6%9C%AA%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99/</id>
    <published>2021-07-05T09:45:23.000Z</published>
    <updated>2022-01-01T14:32:15.494Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL中，查询条件匹配的时候是否区分大小写？什么情况下区分？什么情况下不区分？遇到需要区分但是没有区分的场景该如何处理？</p><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>考虑如下场景：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use test_0705;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_test <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;CodingCat&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> CodingCat <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> CODINGCAT <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> codingcat <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><p>从上图我们看到，查询条件中指定要查询的是<code>name=&#39;CodingCat&#39;</code>，但是结果把<code>CODINGCAT</code>和<code>codingcat</code>一起给查询出来了，可见此查询结果并未区分大小写。</p><h2 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h2><p>我们知道，在MySQL中有排序规则这个概念，排序规则表示在规定的存储的数据编码格式下的比较规则，如是否区分大小写等。针对上面的场景，查看表结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table tb_test;</span><br><span class="line">+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table   | Create Table                                                                                                                                                                |</span><br><span class="line">+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| tb_test | CREATE TABLE &#96;tb_test&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;name&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;4 DEFAULT CHARSET&#x3D;utf8 |</span><br><span class="line">+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p>该表继承了数据库的排序规则，数据库建表语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database test_0705;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database  <span class="operator">|</span> <span class="keyword">Create</span> Database                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> test_0705 <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `test_0705` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><p>从数据库建表语句来看，并没有指定排序规则，则该数据库继承了全局的排序规则，查看数据库的排序规则如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name        <span class="operator">|</span> <span class="keyword">Value</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> collation_connection <span class="operator">|</span> utf8mb4_general_ci <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_database   <span class="operator">|</span> utf8_general_ci    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_server     <span class="operator">|</span> utf8mb4_general_ci <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+--------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.38</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><p>从全局的配置来看，数据库服务器使用的是<code>utf8mb4_general_ci</code>排序规则，后缀有ci，意思是case insensitive，即大小写不敏感，所以查询出来的结果不区分大小写。</p><p>在MySQL中，排序规则常见有带后缀ci和不带ci两种，如utf8_bin和utf8_genera_ci，带ci表示区分大小写，否则不区分。</p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>对于上面的问题，如果在设置了字符排序规则是带ci后缀的，但是又想要查询结果是区分大小写，怎么做？有两种解决方法。</p><ul><li><p>查询时在需要区分大小写的字段条件上使用binary关键字</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_test <span class="keyword">where</span> <span class="type">binary</span> name <span class="operator">=</span> <span class="string">&#x27;CodingCat&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> CodingCat <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li><li><p>修改表中字段的排序规则</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb_test MODIFY <span class="keyword">COLUMN</span> name <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="type">BINARY</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>;</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.08</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> tb_test;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span>   <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                                                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> tb_test <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_test` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_test <span class="keyword">where</span> <span class="type">binary</span> name <span class="operator">=</span> <span class="string">&#x27;CodingCat&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> CodingCat <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">MySQL中，查询条件匹配的时候是否区分大小写？什么情况下区分？什么情况下不区分？遇到需要区分但是没有区分的场景该如何处理？</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>冒泡算法的Python实现</title>
    <link href="http://blog.codingcat.net/2021/07/01/Python%E7%AE%97%E6%B3%95%E4%B9%8B%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/"/>
    <id>http://blog.codingcat.net/2021/07/01/Python%E7%AE%97%E6%B3%95%E4%B9%8B%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/</id>
    <published>2021-07-01T07:33:59.000Z</published>
    <updated>2022-01-01T14:32:15.499Z</updated>
    
    <content type="html"><![CDATA[<p>算法是程序设计的基础，在诸多算法之中，排序算法是我们接触比较多的算法。冒泡算法是十大排序算法之一，比较常见，在面试中经常会被问到。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>冒泡算法原理是十大排序算法之一，比较常见。其原理是重复地走访要排序的数列，一次比较相邻两个元素，如果元素位置错误，则交换位置，直到没有数据需要交换为止。</p><p>冒泡排序中，最大的元素在每一次排序后都会跑到数列右端，就像开水中的水泡网上冒一样，最大的泡先冒出来。</p><p>冒泡排序也叫下沉排序，此时是将小的元素往右移，即每趟排序都将数组内的最小元素移到数组最左端。</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol><li>遍历数组，比较相邻两个元素，如果第一个大于第二个，则交换位置；</li><li>对每一对相邻的元素做同样的动作，从开始第一对到最后一对，完成后，最大的元素将跑到数组的最右端，完成第一趟排序；</li><li>对所有元素重复上面的步骤，除了最后一个；</li><li>重复上面的步骤，每次排序的元素将越来越少，直到没有元素需要比较为止。</li></ol><h2 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h2><p><img src="%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F.gif" alt="冒泡排序"></p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>冒泡排序使用Python实现如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bubble_sort</span>(<span class="params">array</span>):</span></span><br><span class="line">    length = <span class="built_in">len</span>(array)</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length-index):</span><br><span class="line">            <span class="keyword">if</span> array[i-<span class="number">1</span>] &gt; array[i]:</span><br><span class="line">                array[i-<span class="number">1</span>], array[i] = array[i], array[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> array</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = [<span class="number">16</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">19</span>, <span class="number">18</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">49</span>]</span><br><span class="line">print(bubble_sort(l))</span><br></pre></td></tr></table></figure><p>对于上面的代码，如果要排序的数组本身是有序的，也会老老实实的跑完n趟（n为数组中元素个数），但是这种情况下，是不必要的，因此可加一个标志，如果已经是有序的，即没有元素交换，则结束排序过程：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bubble_sort</span>(<span class="params">array</span>):</span></span><br><span class="line">    length = <span class="built_in">len</span>(array)</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length-index):</span><br><span class="line">            <span class="keyword">if</span> array[i-<span class="number">1</span>] &gt; array[i]:</span><br><span class="line">                array[i-<span class="number">1</span>], array[i] = array[i], array[i - <span class="number">1</span>]</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            <span class="keyword">return</span> array</span><br><span class="line">    <span class="keyword">return</span> array</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = [<span class="number">16</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">19</span>, <span class="number">18</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">49</span>]</span><br><span class="line">print(bubble_sort(l))</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">算法是程序设计的基础，在诸多算法之中，排序算法是我们接触比较多的算法。冒泡算法是十大排序算法之一，比较常见，在面试中经常会被问到。</summary>
    
    
    
    <category term="算法" scheme="http://blog.codingcat.net/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="排序算法" scheme="http://blog.codingcat.net/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"/>
    
    <category term="冒泡排序" scheme="http://blog.codingcat.net/tags/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>InnoDB Cluster部署</title>
    <link href="http://blog.codingcat.net/2021/06/10/InnoDB-Cluster%E9%83%A8%E7%BD%B2/"/>
    <id>http://blog.codingcat.net/2021/06/10/InnoDB-Cluster%E9%83%A8%E7%BD%B2/</id>
    <published>2021-06-10T08:22:15.000Z</published>
    <updated>2022-01-01T14:32:15.489Z</updated>
    
    <content type="html"><![CDATA[<p>部署一个MySQL 8.0.25 InnoDB Cluster集群</p><h2 id="InnoDB-Cluster集群简介"><a href="#InnoDB-Cluster集群简介" class="headerlink" title="InnoDB Cluster集群简介"></a>InnoDB Cluster集群简介</h2><p>![InnoDB Cluster架构](InnoDB Cluster架构.jpg)</p><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><p>准备三台虚拟机</p><table><thead><tr><th></th><th>服务器1</th><th>服务器2</th><th>服务器3</th><th>端口</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS7</td><td>CentOS7</td><td>CentOS7</td><td>/</td></tr><tr><td>IP</td><td>192.168.165.156</td><td>192.168.165.157</td><td>192.168.165.225</td><td>/</td></tr><tr><td>主机名</td><td>db156</td><td>db156</td><td>db225</td><td>/</td></tr><tr><td>MySQL Server 8.0.25</td><td>MGR 节点一</td><td>MGR 节点二</td><td>MGR 节点三</td><td>3306</td></tr><tr><td>MySQL Shell 8.0.25</td><td>MySQL Shell节点一</td><td>MySQL Shell节点二</td><td>MySQL Shell节点三</td><td>/</td></tr><tr><td>MySQL Router 8.0.25</td><td>MySQL Router节点一</td><td>MySQL Router节点二</td><td>MySQL Router节点三</td><td>6446(写)、6447（读）</td></tr></tbody></table><h2 id="部署说明"><a href="#部署说明" class="headerlink" title="部署说明"></a>部署说明</h2><h3 id="安装顺序"><a href="#安装顺序" class="headerlink" title="安装顺序"></a>安装顺序</h3><p>安装MySQL Server—&gt;启用组复制—&gt;安装MySQL Shell —&gt; 创建InnoDB Cluster集群—&gt; 安装MySQL Router</p><h3 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h3><table><thead><tr><th>安装包名</th><th>MD5值</th><th>下载连接</th></tr></thead><tbody><tr><td>mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</td><td>a12142a969531cebd845844620bb44a4</td><td><a href="https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz">https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</a></td></tr><tr><td>mysql-shell-8.0.25-linux-glibc2.12-x86-64bit.tar.gz</td><td>9192ea694ac97a5c5715806ddcf84932</td><td><a href="https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz">https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz</a></td></tr><tr><td>mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</td><td>bcd9b81f422667dbabd0a5d7bbf7638a</td><td><a href="https://dev.mysql.com/get/Downloads/MySQL-Router/mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz">https://dev.mysql.com/get/Downloads/MySQL-Router/mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</a></td></tr></tbody></table><h2 id="安装MySQL-Server"><a href="#安装MySQL-Server" class="headerlink" title="安装MySQL Server"></a>安装MySQL Server</h2><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><h3 id="创建相关用户"><a href="#创建相关用户" class="headerlink" title="创建相关用户"></a>创建相关用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 ~]# groupadd mysql &amp;&amp; useradd -r -g mysql -s /bin/false mysql</span><br><span class="line">groupadd: group &#x27;mysql&#x27; already exists</span><br><span class="line">[root@db156 ~]# cat /etc/passwd | grep -iw  &quot;mysql&quot;</span><br><span class="line">mysql:x:997:1000::/home/mysql:/bin/false</span><br></pre></td></tr></table></figure><h3 id="下载并解压安装包"><a href="#下载并解压安装包" class="headerlink" title="下载并解压安装包"></a>下载并解压安装包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# wget https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-8.0&#x2F;mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">--2021-06-10 04:43:21--  https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-8.0&#x2F;mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-8.0&#x2F;mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz [following]</span><br><span class="line">--2021-06-10 04:43:22--  https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-8.0&#x2F;mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 104.71.212.231</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|104.71.212.231|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 896219776 (855M) [text&#x2F;plain]</span><br><span class="line">Saving to: ‘mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz’</span><br><span class="line"></span><br><span class="line">100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;] 896,219,776 14.2MB&#x2F;s   in 66s    </span><br><span class="line"></span><br><span class="line">2021-06-10 04:44:29 (13.0 MB&#x2F;s) - ‘mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz’ saved [896219776&#x2F;896219776]</span><br><span class="line"></span><br><span class="line">[root@db156 opt]# wget https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-Shell&#x2F;mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz</span><br><span class="line">--2021-06-10 04:44:39--  https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-Shell&#x2F;mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz</span><br><span class="line">Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-Shell&#x2F;mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz [following]</span><br><span class="line">--2021-06-10 04:44:41--  https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-Shell&#x2F;mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 104.71.212.231</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|104.71.212.231|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 41487987 (40M) [application&#x2F;x-tar-gz]</span><br><span class="line">Saving to: ‘mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;] 41,487,987  11.6MB&#x2F;s   in 3.8s   </span><br><span class="line"></span><br><span class="line">2021-06-10 04:44:45 (10.4 MB&#x2F;s) - ‘mysql-shell-8.0.25-linux-glibc2.12-x86-32bit.tar.gz’ saved [41487987&#x2F;41487987]</span><br><span class="line"></span><br><span class="line">[root@db156 opt]# wget https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-Router&#x2F;mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">--2021-06-10 04:44:53--  https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-Router&#x2F;mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-Router&#x2F;mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz [following]</span><br><span class="line">--2021-06-10 04:44:54--  https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-Router&#x2F;mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 104.71.212.231</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|104.71.212.231|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 65288920 (62M) [text&#x2F;plain]</span><br><span class="line">Saving to: ‘mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz’</span><br><span class="line"></span><br><span class="line">100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;] 65,288,920  12.5MB&#x2F;s   in 6.1s   </span><br><span class="line"></span><br><span class="line">2021-06-10 04:45:01 (10.3 MB&#x2F;s) - ‘mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz’ saved [65288920&#x2F;65288920]</span><br><span class="line"></span><br><span class="line">[root@db156 opt]# tar -xf mysql-8.0.25-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">[root@db156 opt]# mv mysql-8.0.25-linux-glibc2.12-x86_64 &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br><span class="line">[root@db156 opt]# chown -R mysql:mysql &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br><span class="line">[root@db156 opt]# chmod -R 755 &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure><h3 id="创建相关目录"><a href="#创建相关目录" class="headerlink" title="创建相关目录"></a>创建相关目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# mkdir -p &#x2F;data&#x2F;mysql&#x2F;&#123;data,binlog,relay&#125;</span><br><span class="line">[root@db156 opt]# chown -R mysql:mysql &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line">[root@db156 opt]# chmod -R 750 &#x2F;data&#x2F;mysql&#x2F;</span><br></pre></td></tr></table></figure><h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server_id&#x3D;13306</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;1</span><br><span class="line">transaction_write_set_extraction&#x3D;XXHASH64</span><br><span class="line">loose-group_replication_group_name&#x3D;&#39;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&#39;</span><br><span class="line">loose-group_replication_start_on_boot&#x3D;off</span><br><span class="line">loose-group_replication_ip_whitelist&#x3D;&#39;192.168.165.0&#x2F;24&#39;</span><br><span class="line">loose-group_replication_local_address&#x3D;&#39;192.168.165.157:33061&#39;</span><br><span class="line">loose-group_replication_group_seeds&#x3D;&#39;192.168.165.156:33061,192.168.165.157:33061,192.168.165.225:33061&#39;</span><br><span class="line">loose-group_replication_bootstrap_group&#x3D;off</span><br><span class="line">loose-group_replication_single_primary_mode&#x3D;on</span><br><span class="line">loose-group_replication_enforce_update_everywhere_checks&#x3D;off</span><br><span class="line">loose-group_replication_recovery_get_public_key&#x3D;on</span><br><span class="line">loose-group_replication_recovery_use_ssl&#x3D;off</span><br><span class="line">loose-group_replication_ssl_mode&#x3D;&#39;DISABLED&#39;</span><br><span class="line">loose-group_replication_consistency&#x3D;&#39;EVENTUAL&#39;</span><br><span class="line">loose-group_replication_member_expel_timeout&#x3D;5</span><br><span class="line">report_host&#x3D;&#39;192.168.165.157&#39;</span><br><span class="line">report_port&#x3D;3306</span><br><span class="line">plugin_load_add &#x3D;&#39;group_replication.so&#39;</span><br><span class="line">auto_increment_increment&#x3D;1</span><br><span class="line">auto_increment_offset&#x3D;1</span><br><span class="line">mysqlx_port&#x3D;33060</span><br><span class="line">admin_port&#x3D;33062</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql&#x2F;data</span><br><span class="line">basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">user&#x3D;mysql</span><br></pre></td></tr></table></figure><h3 id="初始化MySQL-Server"><a href="#初始化MySQL-Server" class="headerlink" title="初始化MySQL Server"></a>初始化MySQL Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --initialize-insecure</span><br><span class="line">2021-06-10T08:12:00.192163Z 0 [System] [MY-013169] [Server] &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld (mysqld 8.0.25) initializing of server in progress as process 10863</span><br><span class="line">2021-06-10T08:12:00.364089Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2021-06-10T08:12:05.120563Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2021-06-10T08:12:05.548074Z 0 [Warning] [MY-013501] [Server] Ignoring --plugin-load[_add] list as the server is running with --initialize(-insecure).</span><br><span class="line">2021-06-10T08:12:06.717610Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_group_name&#x3D;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&#39;.</span><br><span class="line">2021-06-10T08:12:06.718217Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_start_on_boot&#x3D;off&#39;.</span><br><span class="line">2021-06-10T08:12:06.718823Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_ip_whitelist&#x3D;192.168.165.0&#x2F;24&#39;.</span><br><span class="line">2021-06-10T08:12:06.719416Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_local_address&#x3D;192.168.165.156:33061&#39;.</span><br><span class="line">2021-06-10T08:12:06.719969Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_group_seeds&#x3D;192.168.165.156:33061,192.168.165.157:33061,192.168.165.225:33061&#39;.</span><br><span class="line">2021-06-10T08:12:06.720542Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_bootstrap_group&#x3D;off&#39;.</span><br><span class="line">2021-06-10T08:12:06.721103Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_single_primary_mode&#x3D;on&#39;.</span><br><span class="line">2021-06-10T08:12:06.721683Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_enforce_update_everywhere_checks&#x3D;off&#39;.</span><br><span class="line">2021-06-10T08:12:06.722250Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_recovery_get_public_key&#x3D;on&#39;.</span><br><span class="line">2021-06-10T08:12:06.722873Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_recovery_use_ssl&#x3D;off&#39;.</span><br><span class="line">2021-06-10T08:12:06.723485Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_ssl_mode&#x3D;DISABLED&#39;.</span><br><span class="line">2021-06-10T08:12:06.724060Z 0 [Warning] [MY-000067] [Server] unknown variable &#39;loose-group_replication_member_expel_timeout&#x3D;5&#39;.</span><br><span class="line">2021-06-10T08:12:06.727059Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br></pre></td></tr></table></figure><h3 id="配置启动文件并启动MySQL"><a href="#配置启动文件并启动MySQL" class="headerlink" title="配置启动文件并启动MySQL"></a>配置启动文件并启动MySQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# vi &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mysqld.service</span><br><span class="line">[root@db156 opt]# cat &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mysqld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;MySQL Server</span><br><span class="line">Documentation&#x3D;man:mysqld(8)</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;8.0&#x2F;en&#x2F;using-systemd.html</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;syslog.target</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User&#x3D;mysql</span><br><span class="line">Group&#x3D;mysql</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld_safe --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf</span><br><span class="line">LimitNOFILE &#x3D; 5000</span><br><span class="line">[root@db156 opt]# systemctl start mysqld </span><br><span class="line">[root@db156 opt]# systemctl status mysqld      </span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mysqld.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2021-06-10 04:57:12 EDT; 10s ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;8.0&#x2F;en&#x2F;using-systemd.html</span><br><span class="line"> Main PID: 14232 (mysqld_safe)</span><br><span class="line">   CGroup: &#x2F;system.slice&#x2F;mysqld.service</span><br><span class="line">           ├─14232 &#x2F;bin&#x2F;sh &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld_safe --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf</span><br><span class="line">           └─14626 &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql --datadir&#x3D;&#x2F;data&#x2F;mysql&#x2F;data --plugin-dir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;lib&#x2F;plugin --log-error&#x3D;db156.err --pid-fil...</span><br><span class="line"></span><br><span class="line">Jun 10 04:57:12 db156 systemd[1]: Started MySQL Server.</span><br><span class="line">Jun 10 04:57:13 db156 mysqld_safe[14232]: 2021-06-10T08:57:13.594106Z mysqld_safe Logging to &#39;&#x2F;data&#x2F;mysql&#x2F;data&#x2F;db156.err&#39;.</span><br><span class="line">Jun 10 04:57:13 db156 mysqld_safe[14232]: 2021-06-10T08:57:13.689214Z mysqld_safe Starting mysqld daemon with databases from &#x2F;data&#x2F;mysql&#x2F;data</span><br></pre></td></tr></table></figure><p>在执行<code>systemctl start mysqld </code>如果报错<code>Failed to start mysqld.service: Unit not found.</code>,可以执行<code>systemctl daemon-reload</code>解决。</p><h3 id="修改本地账号密码并设置不过期"><a href="#修改本地账号密码并设置不过期" class="headerlink" title="修改本地账号密码并设置不过期"></a>修改本地账号密码并设置不过期</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -e &quot;SET SQL_LOG_BIN&#x3D;0;SET global super_read_only&#x3D;OFF; SET global read_only&#x3D;OFF; alter user &#39;root&#39;@&#39;localhost&#39; password expire never; set password for &#39;root&#39;@&#39;localhost&#39;&#x3D;&#39;123456&#39;;flush privileges; SET SQL_LOG_BIN&#x3D;1;&quot;</span><br></pre></td></tr></table></figure><h3 id="创建复制账号并授权"><a href="#创建复制账号并授权" class="headerlink" title="创建复制账号并授权"></a>创建复制账号并授权</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN&#x3D;0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER IF NOT EXISTS &#96;repl&#96;@&#96;192.168.165.156&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">CREATE USER IF NOT EXISTS &#96;repl&#96;@&#96;192.168.165.157&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">CREATE USER IF NOT EXISTS &#96;repl&#96;@&#96;192.168.165.225&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER IF NOT EXISTS &#96;repl&#96;@&#96;192.168.165.157&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER IF NOT EXISTS &#96;repl&#96;@&#96;192.168.165.225&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">GRANT REPLICATION SLAVE, REPLICATION CLIENT, BACKUP_ADMIN ON *.* TO &#96;repl&#96;@&#96;192.168.165.156&#96;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT, BACKUP_ADMIN ON *.* TO &#96;repl&#96;@&#96;192.168.165.156&#96;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT, BACKUP_ADMIN ON *.* TO &#96;repl&#96;@&#96;192.168.165.157&#96;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT, BACKUP_ADMIN ON *.* TO &#96;repl&#96;@&#96;192.168.165.225&#96;; </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN&#x3D;1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><h3 id="创建管理账号并授权"><a href="#创建管理账号并授权" class="headerlink" title="创建管理账号并授权"></a>创建管理账号并授权</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN&#x3D;0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER IF NOT EXISTS &#96;icadmin&#96;@&#96;192.168.165.%&#96; IDENTIFIED BY &#39;123456&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT SELECT, RELOAD, SHUTDOWN, PROCESS, FILE, SUPER, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE USER ON *.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT BACKUP_ADMIN,CLONE_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,SYSTEM_VARIABLES_ADMIN ON *.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">GRANT INSERT, UPDATE, DELETE ON &#96;mysql&#96;.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT INSERT, UPDATE, DELETE ON &#96;mysql&#96;.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT INSERT, UPDATE, DELETE, CREATE, DROP, REFERENCES, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, EVENT, TRIGGER ON &#96;mysql_innodb_cluster_metadata&#96;.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT INSERT, UPDATE, DELETE, CREATE, DROP, REFERENCES, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, EVENT, TRIGGER ON &#96;mysql_innodb_cluster_metadata_bkp&#96;.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT INSERT, UPDATE, DELETE, CREATE, DROP, REFERENCES, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, EVENT, TRIGGER ON &#96;mysql_innodb_cluster_metadata_previous&#96;.* TO &#96;icadmin&#96;@&#96;192.168.165.%&#96; WITH GRANT OPTION;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN&#x3D;1;</span><br><span class="line">Query OK, 0 rows affected (0.32 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN&#x3D;1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><h3 id="安装组复制插件"><a href="#安装组复制插件" class="headerlink" title="安装组复制插件"></a>安装组复制插件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME &#39;group_replication.so&#39;;</span><br><span class="line">ERROR 1125 (HY000): Function &#39;group_replication&#39; already exists</span><br><span class="line">mysql&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS  WHERE PLUGIN_NAME LIKE &#39;%group_replication%&#39;;</span><br><span class="line">+-------------------+---------------+</span><br><span class="line">| PLUGIN_NAME       | PLUGIN_STATUS |</span><br><span class="line">+-------------------+---------------+</span><br><span class="line">| group_replication | ACTIVE        |</span><br><span class="line">+-------------------+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><h3 id="设置复制通道"><a href="#设置复制通道" class="headerlink" title="设置复制通道"></a>设置复制通道</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_USER&#x3D;&#39;repl&#39;, MASTER_PASSWORD&#x3D;&#39;123456&#39; FOR CHANNEL &#39;group_replication_recovery&#39;;</span><br><span class="line">Query OK, 0 rows affected, 5 warnings (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT User_name,Channel_name FROM mysql.slave_master_info WHERE user_name &#x3D; &#39;repl&#39;;</span><br><span class="line">+-----------+----------------------------+</span><br><span class="line">| User_name | Channel_name               |</span><br><span class="line">+-----------+----------------------------+</span><br><span class="line">| repl      | group_replication_recovery |</span><br><span class="line">+-----------+----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET global group_replication_recovery_get_public_key&#x3D;ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><h3 id="查看MySQL进程"><a href="#查看MySQL进程" class="headerlink" title="查看MySQL进程"></a>查看MySQL进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# ps -ef | grep mysql</span><br><span class="line">mysql    14232     1  0 04:57 ?        00:00:00 &#x2F;bin&#x2F;sh &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld_safe --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf</span><br><span class="line">mysql    14626 14232  0 04:57 ?        00:00:03 &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql --datadir&#x3D;&#x2F;data&#x2F;mysql&#x2F;data --plugin-dir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;lib&#x2F;plugin --log-error&#x3D;db156.err --pid-file&#x3D;db156.pid</span><br><span class="line">root     15500  9686  0 05:12 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mysql</span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><blockquote><p>说明：其他两个节点也按照以上步骤部署</p></blockquote><h2 id="启用MGR组复制"><a href="#启用MGR组复制" class="headerlink" title="启用MGR组复制"></a>启用MGR组复制</h2><p>三个MySQL Server实例部署完成之后，就可以启用组复制了。</p><p>对于组复制，数据必须存储在InnoDB事务存储引擎中，使用其他存储引擎（包括临时 MEMORY存储引擎）可能会导致组复制中的错误。disabled_storage_engines 如下设置 系统变量以防止其使用：</p><p>disabled_storage_engines=”MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY”</p><p>修改配置文件，添加上面的配置并重启即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# vi &#x2F;etc&#x2F;my.cnf </span><br><span class="line">[root@db156 opt]# cat &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id&#x3D;13306</span><br><span class="line">gtid_mode&#x3D;on</span><br><span class="line">enforce_gtid_consistency&#x3D;1</span><br><span class="line">transaction_write_set_extraction&#x3D;XXHASH64</span><br><span class="line">loose-group_replication_group_name&#x3D;&#39;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&#39;</span><br><span class="line">loose-group_replication_start_on_boot&#x3D;off</span><br><span class="line">loose-group_replication_ip_whitelist&#x3D;&#39;192.168.165.0&#x2F;24&#39;</span><br><span class="line">loose-group_replication_local_address&#x3D;&#39;192.168.165.156:33061&#39;</span><br><span class="line">loose-group_replication_group_seeds&#x3D;&#39;192.168.165.156:33061,192.168.165.157:33061,192.168.165.225:33061&#39;</span><br><span class="line">loose-group_replication_bootstrap_group&#x3D;off</span><br><span class="line">loose-group_replication_single_primary_mode&#x3D;on</span><br><span class="line">loose-group_replication_enforce_update_everywhere_checks&#x3D;off</span><br><span class="line">loose-group_replication_recovery_get_public_key&#x3D;on</span><br><span class="line">loose-group_replication_recovery_use_ssl&#x3D;off</span><br><span class="line">loose-group_replication_ssl_mode&#x3D;&#39;DISABLED&#39;</span><br><span class="line">loose-group_replication_consistency&#x3D;&#39;EVENTUAL&#39;</span><br><span class="line">loose-group_replication_member_expel_timeout&#x3D;5</span><br><span class="line">report_host&#x3D;&#39;192.168.165.156&#39;</span><br><span class="line">report_port&#x3D;3306</span><br><span class="line">plugin_load_add &#x3D;&#39;group_replication.so&#39;</span><br><span class="line">auto_increment_increment&#x3D;1</span><br><span class="line">auto_increment_offset&#x3D;1</span><br><span class="line">mysqlx_port&#x3D;33060</span><br><span class="line">admin_port&#x3D;33062</span><br><span class="line">datadir&#x3D;&#x2F;data&#x2F;mysql&#x2F;data</span><br><span class="line">basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">bled_storage_engines&#x3D;&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span><br><span class="line">[root@db225 opt]# systemctl restart mysqld</span><br></pre></td></tr></table></figure><p>首次启动组复制的过程称为引导，，可以使用group_replication_bootstrap_group系统变量来引导组，且只能在一个实例上执行并只能执行一次。</p><p>我们选择节点一上执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group&#x3D;ON;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION USER&#x3D;&#39;repl&#39;, PASSWORD&#x3D;&#39;123456&#39;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (2.22 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group&#x3D;OFF;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p>节点二及节点三：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@db225 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uroot -S &#x2F;tmp&#x2F;mysql.sock -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION USER&#x3D;&#39;repl&#39;, PASSWORD&#x3D;&#39;123456&#39;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (2.64 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p>在将其他节点添加至复制组时，如果报一下错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION USER&#x3D;&#39;repl&#39;, PASSWORD&#x3D;&#39;123456&#39;;</span><br><span class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</span><br></pre></td></tr></table></figure><p>查看到日志如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021-06-10T10:42:54.535154Z 10 [System] [MY-010597] [Repl] &#39;CHANGE MASTER TO FOR CHANNEL &#39;group_replication_applier&#39; executed&#39;. Previous state master_host&#x3D;&#39;&#39;, master_port&#x3D; 3306, master_log_file&#x3D;&#39;&#39;, master_log_pos&#x3D; 4, master_bind&#x3D;&#39;&#39;. New state master_host&#x3D;&#39;&lt;NULL&gt;&#39;, master_port&#x3D; 0, master_log_file&#x3D;&#39;&#39;, master_log_pos&#x3D; 4, master_bind&#x3D;&#39;&#39;.</span><br><span class="line">2021-06-10T10:42:57.045266Z 0 [ERROR] [MY-011526] [Repl] Plugin group_replication reported: &#39;This member has more executed transactions than those present in the group. Local transactions: 689d5d1d-c9cc-11eb-8243-005056a0d28b:1 &gt; Group transactions: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&#39;</span><br><span class="line">2021-06-10T10:42:57.056782Z 0 [ERROR] [MY-011522] [Repl] Plugin group_replication reported: &#39;The member contains transactions not present in the group. The member will now exit the group.&#39;</span><br><span class="line">2021-06-10T10:42:57.056911Z 0 [System] [MY-011503] [Repl] Plugin group_replication reported: &#39;Group membership changed to 192.168.165.157:3306, 192.168.165.156:3306 on view 16233217077427225:2.&#39;</span><br><span class="line">2021-06-10T10:43:00.730039Z 0 [System] [MY-011504] [Repl] Plugin group_replication reported: &#39;Group membership changed: This member has left the group.&#39;</span><br><span class="line">2021-06-10T10:43:00.758719Z 9 [System] [MY-011566] [Repl] Plugin group_replication reported: &#39;Setting super_read_only&#x3D;OFF.&#39;</span><br></pre></td></tr></table></figure><p>则在该节点上执行<code>reset master</code>可以解决。</p><p>查看组复制状态(任何一个实例均可查询)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST     | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| group_replication_applier | 689d5d1d-c9cc-11eb-8243-005056a0d28b | 192.168.165.157 |        3306 | ONLINE       | SECONDARY   | 8.0.25         |</span><br><span class="line">| group_replication_applier | 71d57215-c9cc-11eb-a5ac-005056a098ec | 192.168.165.225 |        3306 | ONLINE       | SECONDARY   | 8.0.25         |</span><br><span class="line">| group_replication_applier | 8b5f525d-c9c3-11eb-bf4e-005056a0bb1a | 192.168.165.156 |        3306 | ONLINE       | PRIMARY     | 8.0.25         |</span><br><span class="line">+---------------------------+--------------------------------------+-----------------+-------------+--------------+-------------+----------------+</span><br><span class="line">3 rows in set (1.54 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p>至此，MGR三节点的组复制搭建完成。</p><h2 id="安装MySQL-Shell"><a href="#安装MySQL-Shell" class="headerlink" title="安装MySQL Shell"></a>安装MySQL Shell</h2><p>安装过程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# tar -xf mysql-shell-8.0.25-linux-glibc2.12-x86-64bit.tar.gz </span><br><span class="line">[root@db156 opt]# mv mysql-shell-8.0.25-linux-glibc2.12-x86-64bit &#x2F;usr&#x2F;local&#x2F;mysqlshell</span><br><span class="line">[root@db156 opt]# chown -R mysql:mysql &#x2F;usr&#x2F;local&#x2F;mysqlshell&#x2F;</span><br><span class="line">[root@db156 opt]# chmod -R 755 &#x2F;usr&#x2F;local&#x2F;mysqlshell&#x2F;</span><br><span class="line">[root@db156 opt]# echo &quot;export PATH&#x3D;\$PATH:&#x2F;usr&#x2F;local&#x2F;mysqlshell&#x2F;bin&quot; &gt;&gt; &#x2F;etc&#x2F;profile</span><br><span class="line">[root@db156 opt]# source &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure><p>三个节点均执行以上步骤安装。</p><h2 id="创建InnoDB-Cluster集群"><a href="#创建InnoDB-Cluster集群" class="headerlink" title="创建InnoDB Cluster集群"></a>创建InnoDB Cluster集群</h2><p>通过mysqlsh命令使用安装MySQL Server时创建的管理账号连接到MySQL 实例，执行<code>dba.createCluster()</code>创建集群，并过过<code>dba.getCluster(&quot;testCluster&quot;).status()</code>查看集群状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@db225 opt]# mysqlsh icadmin@192.168.165.156:3306</span><br><span class="line">Please provide the password for &#39;icadmin@192.168.165.156:3306&#39;: ******</span><br><span class="line">Save password for &#39;icadmin@192.168.165.156:3306&#39;? [Y]es&#x2F;[N]o&#x2F;Ne[v]er (default No): </span><br><span class="line">MySQL Shell 8.0.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2016, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its affiliates.</span><br><span class="line">Other names may be trademarks of their respective owners.</span><br><span class="line"></span><br><span class="line">Type &#39;\help&#39; or &#39;\?&#39; for help; &#39;\quit&#39; to exit.</span><br><span class="line">Creating a session to &#39;icadmin@192.168.165.156:3306&#39;</span><br><span class="line">Fetching schema names for autocompletion... Press ^C to stop.</span><br><span class="line">Your MySQL connection id is 28</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line">No default schema selected; type \use &lt;schema&gt; to set one.</span><br><span class="line"> MySQL  192.168.165.156:3306 ssl  JS &gt; var cluster &#x3D; dba.createCluster(&#39;testCluster&#39;, &#123;adoptFromGR: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &#39;192.168.165.156:3306&#39;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &#39;testCluster&#39; on &#39;192.168.165.156:3306&#39;...</span><br><span class="line"></span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Adding Instance &#39;192.168.165.157:3306&#39;...</span><br><span class="line">Adding Instance &#39;192.168.165.225:3306&#39;...</span><br><span class="line">Adding Instance &#39;192.168.165.156:3306&#39;...</span><br><span class="line">Resetting distributed recovery credentials across the cluster...</span><br><span class="line">NOTE: User &#39;mysql_innodb_cluster_13306&#39;@&#39;%&#39; already existed at instance &#39;192.168.165.156:3306&#39;. It will be deleted and created again with a new password.</span><br><span class="line">NOTE: User &#39;mysql_innodb_cluster_13306&#39;@&#39;%&#39; already existed at instance &#39;192.168.165.156:3306&#39;. It will be deleted and created again with a new password.</span><br><span class="line">Cluster successfully created based on existing replication group.</span><br><span class="line"></span><br><span class="line"> MySQL  192.168.165.156:3306 ssl  JS &gt; dba.getCluster(&quot;testCluster&quot;).status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;192.168.165.156:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;192.168.165.156:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;192.168.165.156:3306&quot;, </span><br><span class="line">                &quot;instanceErrors&quot;: [</span><br><span class="line">                    &quot;NOTE: The required parallel-appliers settings are not enabled on the instance. Use dba.configureInstance() to fix it.&quot;</span><br><span class="line">                ], </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: null, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.0.25&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;192.168.165.157:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;192.168.165.157:3306&quot;, </span><br><span class="line">                &quot;instanceErrors&quot;: [</span><br><span class="line">                    &quot;NOTE: The required parallel-appliers settings are not enabled on the instance. Use dba.configureInstance() to fix it.&quot;</span><br><span class="line">                ], </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: null, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.0.25&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;192.168.165.225:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;192.168.165.225:3306&quot;, </span><br><span class="line">                &quot;instanceErrors&quot;: [</span><br><span class="line">                    &quot;NOTE: The required parallel-appliers settings are not enabled on the instance. Use dba.configureInstance() to fix it.&quot;</span><br><span class="line">                ], </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: null, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.0.25&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;192.168.165.156:3306&quot;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  192.168.165.156:3306 ssl  JS &gt; </span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>“status”: “OK” 表示集群状态是正常的</li><li>“topologyMode”: “Single-Primary” 表示是单主模式</li><li>“mode”: “R/W” 表示可读可写</li><li>“mode”: “R/O” 表示只读</li></ul><h2 id="安装MySQL-Router"><a href="#安装MySQL-Router" class="headerlink" title="安装MySQL Router"></a>安装MySQL Router</h2><p>安装：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# tar -xf mysql-router-8.0.25-linux-glibc2.12-x86_64.tar.xz </span><br><span class="line">[root@db156 opt]# mv mysql-router-8.0.25-linux-glibc2.12-x86_64 &#x2F;usr&#x2F;local&#x2F;mysqlrouter</span><br><span class="line">[root@db156 opt]# chown -R mysql:mysql &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;</span><br><span class="line">[root@db156 opt]# chmod -R 755 &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;</span><br><span class="line">[root@db156 opt]# mkdir -p &#x2F;data&#x2F;mysqlrouter</span><br><span class="line">[root@db156 opt]# chown -R mysql:mysql &#x2F;data&#x2F;mysqlrouter&#x2F;</span><br><span class="line">[root@db156 opt]# echo &quot;export PATH&#x3D;\$PATH:&#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;bin&quot; &gt;&gt; &#x2F;etc&#x2F;profile</span><br><span class="line">[root@db156 opt]# source &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure><p>bootstrap引导:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;bin&#x2F;mysqlrouter --bootstrap icadmin@192.168.165.156:3306 --directory &#x2F;data&#x2F;mysqlrouter --conf-use-sockets --user&#x3D;mysql --name&#x3D;mysql_router_13306 --conf-bind-address&#x3D;192.168.165.156 --account-host&#x3D;&quot;192.168.165.%&quot;</span><br><span class="line">Please enter MySQL password for icadmin: </span><br><span class="line"># Bootstrapping MySQL Router instance at &#39;&#x2F;data&#x2F;mysqlrouter&#39;...</span><br><span class="line"></span><br><span class="line">- Creating account(s) (only those that are needed, if any)</span><br><span class="line">- Verifying account (using it to run SQL queries that would be run by Router)</span><br><span class="line">- Storing account in keyring</span><br><span class="line">- Adjusting permissions of generated files</span><br><span class="line">- Creating configuration &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.conf</span><br><span class="line"></span><br><span class="line"># MySQL Router &#39;mysql_router_13306&#39; configured for the InnoDB Cluster &#39;testCluster&#39;</span><br><span class="line"></span><br><span class="line">After this MySQL Router has been started with the generated configuration</span><br><span class="line"></span><br><span class="line">    $ &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;bin&#x2F;mysqlrouter -c &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.conf</span><br><span class="line"></span><br><span class="line">the cluster &#39;testCluster&#39; can be reached by connecting to:</span><br><span class="line"></span><br><span class="line">## MySQL Classic protocol</span><br><span class="line"></span><br><span class="line">- Read&#x2F;Write Connections: localhost:6446, &#x2F;data&#x2F;mysqlrouter&#x2F;mysql.sock</span><br><span class="line">- Read&#x2F;Only Connections:  localhost:6447, &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlro.sock</span><br><span class="line"></span><br><span class="line">## MySQL X protocol</span><br><span class="line"></span><br><span class="line">- Read&#x2F;Write Connections: localhost:6448, &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlx.sock</span><br><span class="line">- Read&#x2F;Only Connections:  localhost:6449, &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlxro.sock</span><br><span class="line"></span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><p>引导成功后会在/data/mysqlrouter目录下生成所需的数据文件，目录结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# tree &#x2F;data&#x2F;mysqlrouter&#x2F;</span><br><span class="line">&#x2F;data&#x2F;mysqlrouter&#x2F;</span><br><span class="line">├── data</span><br><span class="line">│   ├── ca-key.pem</span><br><span class="line">│   ├── ca.pem</span><br><span class="line">│   ├── keyring</span><br><span class="line">│   ├── router-cert.pem</span><br><span class="line">│   ├── router-key.pem</span><br><span class="line">│   └── state.json</span><br><span class="line">├── log</span><br><span class="line">│   └── mysqlrouter.log</span><br><span class="line">├── mysqlrouter.conf</span><br><span class="line">├── mysqlrouter.key</span><br><span class="line">├── run</span><br><span class="line">├── start.sh</span><br><span class="line">└── stop.sh</span><br><span class="line"></span><br><span class="line">3 directories, 11 files</span><br></pre></td></tr></table></figure><p>生成的MySQL Router配置文件如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# cat &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.conf </span><br><span class="line"># File automatically generated during MySQL Router bootstrap</span><br><span class="line">[DEFAULT]</span><br><span class="line">name&#x3D;mysql_router_13306</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">logging_folder&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;log</span><br><span class="line">runtime_folder&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;run</span><br><span class="line">data_folder&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data</span><br><span class="line">keyring_path&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;keyring</span><br><span class="line">master_key_path&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.key</span><br><span class="line">connect_timeout&#x3D;15</span><br><span class="line">read_timeout&#x3D;30</span><br><span class="line">dynamic_state&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;state.json</span><br><span class="line">client_ssl_cert&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;router-cert.pem</span><br><span class="line">client_ssl_key&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;router-key.pem</span><br><span class="line">client_ssl_mode&#x3D;PREFERRED</span><br><span class="line">server_ssl_mode&#x3D;AS_CLIENT</span><br><span class="line">server_ssl_verify&#x3D;DISABLED</span><br><span class="line"></span><br><span class="line">[logger]</span><br><span class="line">level &#x3D; INFO</span><br><span class="line"></span><br><span class="line">[metadata_cache:testCluster]</span><br><span class="line">cluster_type&#x3D;gr</span><br><span class="line">router_id&#x3D;1</span><br><span class="line">user&#x3D;mysql_router1_7d9sq1vuggg9</span><br><span class="line">metadata_cluster&#x3D;testCluster</span><br><span class="line">ttl&#x3D;0.5</span><br><span class="line">auth_cache_ttl&#x3D;-1</span><br><span class="line">auth_cache_refresh_interval&#x3D;2</span><br><span class="line">use_gr_notifications&#x3D;0</span><br><span class="line"></span><br><span class="line">[routing:testCluster_rw]</span><br><span class="line">bind_address&#x3D;192.168.165.156</span><br><span class="line">bind_port&#x3D;6446</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysql.sock</span><br><span class="line">destinations&#x3D;metadata-cache:&#x2F;&#x2F;testCluster&#x2F;?role&#x3D;PRIMARY</span><br><span class="line">routing_strategy&#x3D;first-available</span><br><span class="line">protocol&#x3D;classic</span><br><span class="line"></span><br><span class="line">[routing:testCluster_ro]</span><br><span class="line">bind_address&#x3D;192.168.165.156</span><br><span class="line">bind_port&#x3D;6447</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysqlro.sock</span><br><span class="line">destinations&#x3D;metadata-cache:&#x2F;&#x2F;testCluster&#x2F;?role&#x3D;SECONDARY</span><br><span class="line">routing_strategy&#x3D;round-robin-with-fallback</span><br><span class="line">protocol&#x3D;classic</span><br><span class="line"></span><br><span class="line">[routing:testCluster_x_rw]</span><br><span class="line">bind_address&#x3D;192.168.165.156</span><br><span class="line">bind_port&#x3D;6448</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysqlx.sock</span><br><span class="line">destinations&#x3D;metadata-cache:&#x2F;&#x2F;testCluster&#x2F;?role&#x3D;PRIMARY</span><br><span class="line">routing_strategy&#x3D;first-available</span><br><span class="line">protocol&#x3D;x</span><br><span class="line"></span><br><span class="line">[routing:testCluster_x_ro]</span><br><span class="line">bind_address&#x3D;192.168.165.156</span><br><span class="line">bind_port&#x3D;6449</span><br><span class="line">socket&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysqlxro.sock</span><br><span class="line">destinations&#x3D;metadata-cache:&#x2F;&#x2F;testCluster&#x2F;?role&#x3D;SECONDARY</span><br><span class="line">routing_strategy&#x3D;round-robin-with-fallback</span><br><span class="line">protocol&#x3D;x</span><br><span class="line"></span><br><span class="line">[http_server]</span><br><span class="line">port&#x3D;8443</span><br><span class="line">ssl&#x3D;1</span><br><span class="line">ssl_cert&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;router-cert.pem</span><br><span class="line">ssl_key&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;data&#x2F;router-key.pem</span><br><span class="line"></span><br><span class="line">[http_auth_realm:default_auth_realm]</span><br><span class="line">backend&#x3D;default_auth_backend</span><br><span class="line">method&#x3D;basic</span><br><span class="line">name&#x3D;default_realm</span><br><span class="line"></span><br><span class="line">[rest_router]</span><br><span class="line">require_realm&#x3D;default_auth_realm</span><br><span class="line"></span><br><span class="line">[rest_api]</span><br><span class="line"></span><br><span class="line">[http_auth_backend:default_auth_backend]</span><br><span class="line">backend&#x3D;metadata_cache</span><br><span class="line"></span><br><span class="line">[rest_routing]</span><br><span class="line">require_realm&#x3D;default_auth_realm</span><br><span class="line"></span><br><span class="line">[rest_metadata_cache]</span><br><span class="line">require_realm&#x3D;default_auth_realm</span><br><span class="line"></span><br><span class="line">[root@db156 opt]# </span><br></pre></td></tr></table></figure><p>启动MySQL路由：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# bash &#x2F;data&#x2F;mysqlrouter&#x2F;start.sh 2&gt;&amp;1 &gt; &#x2F;dev&#x2F;null &amp;</span><br><span class="line">[root@db156 opt]# ps -ef | grep mysqlrouter</span><br><span class="line">root     24911     1  0 08:00 pts&#x2F;0    00:00:00 sudo ROUTER_PID&#x3D;&#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.pid &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;bin&#x2F;mysqlrouter -c &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.conf --user&#x3D;mysql</span><br><span class="line">mysql    24913 24911  2 08:00 pts&#x2F;0    00:00:01 &#x2F;usr&#x2F;local&#x2F;mysqlrouter&#x2F;bin&#x2F;mysqlrouter -c &#x2F;data&#x2F;mysqlrouter&#x2F;mysqlrouter.conf --user&#x3D;mysql</span><br><span class="line">root     24998  9686  0 08:01 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mysqlrouter</span><br></pre></td></tr></table></figure><p>读写分离测试：使用不同的端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uicadmin -p -h 192.168.165.156 -P 6446    </span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 196</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@hostname as hostname, @@port as port;</span><br><span class="line">+----------+------+</span><br><span class="line">| hostname | port |</span><br><span class="line">+----------+------+</span><br><span class="line">| db156    | 3306 |</span><br><span class="line">+----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uicadmin -p -h 192.168.165.156 -P 6447</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 30</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@hostname as hostname, @@port as port;</span><br><span class="line">+----------+------+</span><br><span class="line">| hostname | port |</span><br><span class="line">+----------+------+</span><br><span class="line">| db225    | 3306 |</span><br><span class="line">+----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@db156 opt]# &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -uicadmin -p -h 192.168.165.156 -P 6447</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1517</span><br><span class="line">Server version: 8.0.25 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@hostname as hostname, @@port as port;</span><br><span class="line">+----------+------+</span><br><span class="line">| hostname | port |</span><br><span class="line">+----------+------+</span><br><span class="line">| db157    | 3306 |</span><br><span class="line">+----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p>可以看到使用读写端口6446时连接的是主节点，而使用只读端口6447连接时是在两个从节点之间切换操作。</p>]]></content>
    
    
    <summary type="html">部署一个MySQL 8.0.25 InnoDB Cluster集群</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="InnoDB Cluster" scheme="http://blog.codingcat.net/tags/InnoDB-Cluster/"/>
    
  </entry>
  
  <entry>
    <title>Django多表关联查询时数据错误</title>
    <link href="http://blog.codingcat.net/2021/06/08/Django%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%95%B0%E6%8D%AE%E9%94%99%E8%AF%AF/"/>
    <id>http://blog.codingcat.net/2021/06/08/Django%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%95%B0%E6%8D%AE%E9%94%99%E8%AF%AF/</id>
    <published>2021-06-08T12:23:24.000Z</published>
    <updated>2022-01-01T14:32:15.477Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景及需求"><a href="#背景及需求" class="headerlink" title="背景及需求"></a>背景及需求</h2><ul><li>表：配置集、配置集版本、配置项</li><li>关系：一个配置集有多个版本，一个配置集版本有多个配置项</li></ul><p><img src="Django%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%95%B0%E6%8D%AE%E9%94%99%E8%AF%AF/image-20211112184343393.png" alt="image-20211112184343393"></p><h2 id="原始写法"><a href="#原始写法" class="headerlink" title="原始写法"></a>原始写法</h2><h3 id="原始代码"><a href="#原始代码" class="headerlink" title="原始代码"></a>原始代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">query = ConfigSet.objects.<span class="built_in">filter</span>(moduletoconfigset__module=module_id).order_by(<span class="string">&quot;-id&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> User.objects.<span class="built_in">filter</span>(bk_username=request.user.username, is_super=<span class="literal">True</span>).exists():</span><br><span class="line">query = query.<span class="built_in">filter</span>(create_by=request.user.username)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标识符is_current_config，代表在当前配置上操作</span></span><br><span class="line"><span class="keyword">if</span> is_current_config:</span><br><span class="line">query = query.<span class="built_in">filter</span>(configsetversion__state=<span class="string">&quot;has&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按搜索条件筛选</span></span><br><span class="line"><span class="keyword">if</span> content:</span><br><span class="line">query = query.<span class="built_in">filter</span>(</span><br><span class="line">Q(data_id__contains=content) | Q(configsetversion__version__contains=content)</span><br><span class="line">).distinct()</span><br><span class="line"></span><br><span class="line">paginator = Paginator(query, page_size)</span><br><span class="line">count = paginator.count</span><br><span class="line">res = paginator.get_page(page).object_list.values()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> is_current_config:</span><br><span class="line">        last_ver = ConfigSetVersion.objects.<span class="built_in">filter</span>(config_set_id=i[<span class="string">&quot;id&quot;</span>], state=<span class="string">&quot;has&quot;</span>).last()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_ver = ConfigSetVersion.objects.<span class="built_in">filter</span>(config_set_id=i[<span class="string">&quot;id&quot;</span>]).last()</span><br><span class="line">    i[<span class="string">&quot;now_version&quot;</span>] = last_ver.version</span><br><span class="line">    i[<span class="string">&quot;scope&quot;</span>] = <span class="string">&quot;,&quot;</span>.join(</span><br><span class="line">        [i.module_name <span class="keyword">for</span> i <span class="keyword">in</span> ModuleToConfigSet.objects.<span class="built_in">filter</span>(config_set_id=i[<span class="string">&quot;id&quot;</span>])]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="查询得到的结果"><a href="#查询得到的结果" class="headerlink" title="查询得到的结果"></a>查询得到的结果</h3><p>当输入’2’查询的时候，查询的结果里面不符合需求：查询配置集ID或版本中包含’2’数据</p><p><img src="Django%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%95%B0%E6%8D%AE%E9%94%99%E8%AF%AF/image-20211112181443714.png" alt="image-20211112181443714"></p><h3 id="生成的SQL"><a href="#生成的SQL" class="headerlink" title="生成的SQL"></a>生成的SQL</h3><p>生成的SQL语句中，出现了同一张表关联了多次进行链表查询，以及where条件的判断，导致数据出错。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">`cw_config_configset`.`id`,</span><br><span class="line">`cw_config_configset`.`create_by`,</span><br><span class="line">`cw_config_configset`.`create_time`,</span><br><span class="line">`cw_config_configset`.`update_time`,</span><br><span class="line">`cw_config_configset`.`update_by`,</span><br><span class="line">`cw_config_configset`.`data_id`,</span><br><span class="line">`cw_config_configset`.`storage_path`,</span><br><span class="line">`cw_config_configset`.`type`,</span><br><span class="line">`cw_config_configset`.`dis`,</span><br><span class="line">`cw_config_configset`.`dis_version` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">`cw_config_configset`</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_moduletoconfigset` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_moduletoconfigset`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_configsetversion`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T4 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T4.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T5 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T5.`config_set_id` )</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T6 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T6.`config_set_id` )</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T7 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T7.`config_set_id` )</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T8 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T8.`config_set_id` )</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T9 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T9.`config_set_id` ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">(</span><br><span class="line">`cw_config_moduletoconfigset`.`<span class="keyword">module</span>` <span class="operator">=</span> <span class="number">117</span> </span><br><span class="line"><span class="keyword">AND</span> `cw_config_configsetversion`.`state` <span class="operator">=</span> <span class="string">&#x27;has&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> T4.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> T5.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> T6.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> ) </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> T7.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> ) </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> T8.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> ) </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> T9.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> ) </span><br><span class="line">) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">`cw_config_configset`.`id` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h3 id="SQL查询结果"><a href="#SQL查询结果" class="headerlink" title="SQL查询结果"></a>SQL查询结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">| id | create_by | create_time         | update_time         | update_by | data_id     | storage_path     | type   | dis      | dis_version |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">| 29 | product   | 2021-10-27 14:52:48 | 2021-11-10 10:03:16 | product   | sfdas       |                  | sfa    |          |             |</span><br><span class="line">|  8 | product   | 2021-10-26 15:56:52 | 2021-10-27 14:25:12 | product   | 31ff        | 13               | 13     | 13       | 13          |</span><br><span class="line">|  3 | product   | 2021-10-22 14:47:04 | NULL                | NULL      | test1022    | &#x2F;desktop&#x2F;newfile | 服务器 | 测试YAPI |             |</span><br><span class="line">|  1 | product   | 2021-10-21 17:18:42 | 2021-10-28 20:51:19 | product   | publish1021 | &#x2F;log&#x2F;test1       | 服务器 |          |             |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">4 rows in set (0.18 sec)</span><br></pre></td></tr></table></figure><h2 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h2><h3 id="预期结果SQL"><a href="#预期结果SQL" class="headerlink" title="预期结果SQL"></a>预期结果SQL</h3><p>根据需求，编写相应的SQL如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">`cw_config_configset`.`id`,</span><br><span class="line">`cw_config_configset`.`create_by`,</span><br><span class="line">`cw_config_configset`.`create_time`,</span><br><span class="line">`cw_config_configset`.`update_time`,</span><br><span class="line">`cw_config_configset`.`update_by`,</span><br><span class="line">`cw_config_configset`.`data_id`,</span><br><span class="line">`cw_config_configsetversion`.`version`,</span><br><span class="line">`cw_config_configset`.`storage_path`,</span><br><span class="line">`cw_config_configset`.`type`,</span><br><span class="line">`cw_config_configset`.`dis`,</span><br><span class="line">`cw_config_configset`.`dis_version` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">`cw_config_configset`</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_configsetversion`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_moduletoconfigset` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_moduletoconfigset`.`config_set_id` ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">`cw_config_configsetversion`.`state` <span class="operator">=</span> <span class="string">&#x27;has&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> `cw_config_configsetversion`.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> ) </span><br><span class="line"><span class="keyword">AND</span> `cw_config_moduletoconfigset`.`<span class="keyword">module</span>` <span class="operator">=</span> <span class="number">117</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">`cw_config_configset`.`id` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h3 id="预期结果"><a href="#预期结果" class="headerlink" title="预期结果"></a>预期结果</h3><p>编写的SQL查询的数据和预期的结果一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+---------+------------------+--------+----------+-------------+</span><br><span class="line">| id | create_by | create_time         | update_time         | update_by | data_id     | version | storage_path     | type   | dis      | dis_version |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+---------+------------------+--------+----------+-------------+</span><br><span class="line">|  3 | product   | 2021-10-22 14:47:04 | NULL                | NULL      | test1022    | 2       | &#x2F;desktop&#x2F;newfile | 服务器 | 测试YAPI |             |</span><br><span class="line">|  1 | product   | 2021-10-21 17:18:42 | 2021-10-28 20:51:19 | product   | publish1021 | 26      | &#x2F;log&#x2F;test1       | 服务器 |          |             |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+---------+------------------+--------+----------+-------------+</span><br><span class="line">2 rows in set (0.11 sec)</span><br></pre></td></tr></table></figure><h2 id="第一次优化"><a href="#第一次优化" class="headerlink" title="第一次优化"></a>第一次优化</h2><p>从上面的Django代码出发，尝试减少Django中使用queryset.filter的次数，特别是其中出钱外键关联的情况，这种情况会导致代码中增加关联的表数量。</p><h3 id="Django代码"><a href="#Django代码" class="headerlink" title="Django代码"></a>Django代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">query = ConfigSet.objects.<span class="built_in">all</span>()</span><br><span class="line">query_dict = &#123;<span class="string">&quot;moduletoconfigset__module&quot;</span>: module_id&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> User.objects.<span class="built_in">filter</span>(bk_username=request.user.username, is_super=<span class="literal">True</span>).exists():</span><br><span class="line">query_dict[<span class="string">&#x27;create_by&#x27;</span>] = request.user.username</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> is_current_config:</span><br><span class="line">query_dict[<span class="string">&#x27;configsetversion__state&#x27;</span>] = <span class="string">&quot;has&quot;</span></span><br><span class="line">query = query.<span class="built_in">filter</span>(**query_dict)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> content:</span><br><span class="line">query = query.<span class="built_in">filter</span>(</span><br><span class="line">Q(data_id__contains=content) | Q(configsetversion__version__contains=content)</span><br><span class="line">).distinct()</span><br><span class="line">query = query.order_by(<span class="string">&quot;-id&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="生成的SQL-1"><a href="#生成的SQL-1" class="headerlink" title="生成的SQL"></a>生成的SQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">`cw_config_configset`.`id`,</span><br><span class="line">`cw_config_configset`.`create_by`,</span><br><span class="line">`cw_config_configset`.`create_time`,</span><br><span class="line">`cw_config_configset`.`update_time`,</span><br><span class="line">`cw_config_configset`.`update_by`,</span><br><span class="line">`cw_config_configset`.`data_id`,</span><br><span class="line">`cw_config_configset`.`storage_path`,</span><br><span class="line">`cw_config_configset`.`type`,</span><br><span class="line">`cw_config_configset`.`dis`,</span><br><span class="line">`cw_config_configset`.`dis_version` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">`cw_config_configset`</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_configsetversion`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_moduletoconfigset` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_moduletoconfigset`.`config_set_id` )</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` T4 <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> T4.`config_set_id` ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">(</span><br><span class="line">`cw_config_configsetversion`.`state` <span class="operator">=</span> <span class="string">&#x27;has&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> `cw_config_moduletoconfigset`.`<span class="keyword">module</span>` <span class="operator">=</span> <span class="number">117</span> </span><br><span class="line"><span class="keyword">AND</span> ( `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">OR</span> T4.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> )) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">`cw_config_configset`.`id` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h3 id="SQL查询结果-1"><a href="#SQL查询结果-1" class="headerlink" title="SQL查询结果"></a>SQL查询结果</h3><p>生成的SQL中关联的表少了，然而数据还是错误的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">| id | create_by | create_time         | update_time         | update_by | data_id     | storage_path     | type   | dis      | dis_version |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">| 29 | product   | 2021-10-27 14:52:48 | 2021-11-10 10:03:16 | product   | sfdas       |                  | sfa    |          |             |</span><br><span class="line">|  8 | product   | 2021-10-26 15:56:52 | 2021-10-27 14:25:12 | product   | 31ff        | 13               | 13     | 13       | 13          |</span><br><span class="line">|  3 | product   | 2021-10-22 14:47:04 | NULL                | NULL      | test1022    | &#x2F;desktop&#x2F;newfile | 服务器 | 测试YAPI |             |</span><br><span class="line">|  1 | product   | 2021-10-21 17:18:42 | 2021-10-28 20:51:19 | product   | publish1021 | &#x2F;log&#x2F;test1       | 服务器 |          |             |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">4 rows in set (0.09 sec)</span><br></pre></td></tr></table></figure><h2 id="最终优化"><a href="#最终优化" class="headerlink" title="最终优化"></a>最终优化</h2><p>如何去优化？从语气的SQL以及第一次优化的情况来看，减少queryset.filter，但是最后使用Q的貌似无法只写将查询条件写到query_dict里面。</p><p>在SQL语句中，OR条件的查询可以修改为使用UNION以提高性能，这里也可以使用这种方式，将Q这种方式的或查询修改为使用UNION的方式来进行查询。</p><h3 id="Django代码-1"><a href="#Django代码-1" class="headerlink" title="Django代码"></a>Django代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">query = ConfigSet.objects.<span class="built_in">all</span>()</span><br><span class="line">query_dict = &#123;<span class="string">&quot;moduletoconfigset__module&quot;</span>: module_id&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> User.objects.<span class="built_in">filter</span>(bk_username=request.user.username, is_super=<span class="literal">True</span>).exists():</span><br><span class="line">query_dict[<span class="string">&quot;create_by&quot;</span>] = request.user.username</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> is_current_config:</span><br><span class="line">query_dict[<span class="string">&quot;configsetversion__state&quot;</span>] = <span class="string">&quot;has&quot;</span></span><br><span class="line"></span><br><span class="line">query_dict2 = &#123;&#125;</span><br><span class="line"><span class="keyword">if</span> content:</span><br><span class="line">query_dict2 = copy.deepcopy(query_dict)</span><br><span class="line">query_dict[<span class="string">&quot;data_id__contains&quot;</span>] = content</span><br><span class="line">query_dict2[<span class="string">&quot;configsetversion__version__contains&quot;</span>] = content</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> query_dict2:</span><br><span class="line">query = query.<span class="built_in">filter</span>(**query_dict).order_by(<span class="string">&quot;-id&quot;</span>).distinct()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">query = query.<span class="built_in">filter</span>(**query_dict).union(query.<span class="built_in">filter</span>(**query_dict2)).order_by(<span class="string">&quot;-id&quot;</span>).distinct()</span><br></pre></td></tr></table></figure><h3 id="生成的SQL-2"><a href="#生成的SQL-2" class="headerlink" title="生成的SQL"></a>生成的SQL</h3><p>生成的SQL和预期的SQL不一致，但是与将预期SQL中的OR条件改用UNION的方式查询是一样的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">( <span class="keyword">SELECT</span></span><br><span class="line">`cw_config_configset`.`id`,</span><br><span class="line">`cw_config_configset`.`create_by`,</span><br><span class="line">`cw_config_configset`.`create_time`,</span><br><span class="line">`cw_config_configset`.`update_time`,</span><br><span class="line">`cw_config_configset`.`update_by`,</span><br><span class="line">`cw_config_configset`.`data_id`,</span><br><span class="line">`cw_config_configset`.`storage_path`,</span><br><span class="line">`cw_config_configset`.`type`,</span><br><span class="line">`cw_config_configset`.`dis`,</span><br><span class="line">`cw_config_configset`.`dis_version` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">`cw_config_configset`</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_configsetversion`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_moduletoconfigset` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_moduletoconfigset`.`config_set_id` ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">( `cw_config_configsetversion`.`state` <span class="operator">=</span> <span class="string">&#x27;has&#x27;</span> <span class="keyword">AND</span> `cw_config_configset`.`data_id` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">AND</span> `cw_config_moduletoconfigset`.`<span class="keyword">module</span>` <span class="operator">=</span> <span class="number">117</span> ) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">`cw_config_configset`.`id` <span class="keyword">ASC</span> </span><br><span class="line">) <span class="keyword">UNION</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">`cw_config_configset`.`id`,</span><br><span class="line">`cw_config_configset`.`create_by`,</span><br><span class="line">`cw_config_configset`.`create_time`,</span><br><span class="line">`cw_config_configset`.`update_time`,</span><br><span class="line">`cw_config_configset`.`update_by`,</span><br><span class="line">`cw_config_configset`.`data_id`,</span><br><span class="line">`cw_config_configset`.`storage_path`,</span><br><span class="line">`cw_config_configset`.`type`,</span><br><span class="line">`cw_config_configset`.`dis`,</span><br><span class="line">`cw_config_configset`.`dis_version` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">`cw_config_configset`</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_configsetversion` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_configsetversion`.`config_set_id` )</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> `cw_config_moduletoconfigset` <span class="keyword">ON</span> ( `cw_config_configset`.`id` <span class="operator">=</span> `cw_config_moduletoconfigset`.`config_set_id` ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">( `cw_config_configsetversion`.`state` <span class="operator">=</span> <span class="string">&#x27;has&#x27;</span> <span class="keyword">AND</span> `cw_config_configsetversion`.`version` <span class="keyword">LIKE</span> <span class="type">BINARY</span> <span class="string">&#x27;%2%&#x27;</span> <span class="keyword">AND</span> `cw_config_moduletoconfigset`.`<span class="keyword">module</span>` <span class="operator">=</span> <span class="number">117</span> ) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">`cw_config_configset`.`id` <span class="keyword">ASC</span> </span><br><span class="line">) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">( <span class="number">1</span> ) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure><h3 id="SQL查询结果-2"><a href="#SQL查询结果-2" class="headerlink" title="SQL查询结果"></a>SQL查询结果</h3><p>执行可以得到正确的结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">| id | create_by | create_time         | update_time         | update_by | data_id     | storage_path     | type   | dis      | dis_version |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">|  3 | product   | 2021-10-22 14:47:04 | NULL                | NULL      | test1022    | &#x2F;desktop&#x2F;newfile | 服务器 | 测试YAPI |             |</span><br><span class="line">|  1 | product   | 2021-10-21 17:18:42 | 2021-10-28 20:51:19 | product   | publish1021 | &#x2F;log&#x2F;test1       | 服务器 |          |             |</span><br><span class="line">+----+-----------+---------------------+---------------------+-----------+-------------+------------------+--------+----------+-------------+</span><br><span class="line">2 rows in set (0.11 sec)</span><br></pre></td></tr></table></figure><h3 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h3><p><img src="Django%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%95%B0%E6%8D%AE%E9%94%99%E8%AF%AF/image-20211112182409956.png" alt="image-20211112182409956"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在Django中使用ORM查询数据时，尽量将查询条件都组装成一个字典的形式去查询，而不是使用queryset.filter的方式。使用queryset.filter可能带来数据不正确的风险（三张及以上表的情况），当出现多表关联的时候性能相对于关联少量表的情况差。</p><p>上面问题的另一中解决方法就是直接使用ORM中的raw方法，直接去执行SQL语句，这样不仅能够得到正确的数据，而且性能还比使用ORM的性能好！</p>]]></content>
    
    
    <summary type="html">三张及以上表关联时使用filter导致数据不正确</summary>
    
    
    
    <category term="Python" scheme="http://blog.codingcat.net/categories/Python/"/>
    
    
    <category term="Python" scheme="http://blog.codingcat.net/tags/Python/"/>
    
    <category term="Django" scheme="http://blog.codingcat.net/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>Django常见问题</title>
    <link href="http://blog.codingcat.net/2021/06/08/Django%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
    <id>http://blog.codingcat.net/2021/06/08/Django%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</id>
    <published>2021-06-08T12:23:24.000Z</published>
    <updated>2022-01-01T14:32:15.480Z</updated>
    
    <content type="html"><![CDATA[<p>本文是一张从<a href="https://django-orm-cookbook-zh-cn.readthedocs.io/zh_CN/latest/introduction.html">https://django-orm-cookbook-zh-cn.readthedocs.io/zh_CN/latest/introduction.html</a>  总结而来的脑图。</p><span id="more"></span><p><img src="Django.png" alt="Django常见问题"></p><p><a href="Django.xmind">下载Xmind脑图</a></p>]]></content>
    
    
    <summary type="html">本文是一张从https://django-orm-cookbook-zh-cn.readthedocs.io/zh_CN/latest/introduction.html  总结而来的脑图。</summary>
    
    
    
    <category term="Python" scheme="http://blog.codingcat.net/categories/Python/"/>
    
    
    <category term="Python" scheme="http://blog.codingcat.net/tags/Python/"/>
    
    <category term="Django" scheme="http://blog.codingcat.net/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>搭建一个单主模式的MGR集群</title>
    <link href="http://blog.codingcat.net/2021/05/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E7%9A%84MGR%E9%9B%86%E7%BE%A4/"/>
    <id>http://blog.codingcat.net/2021/05/10/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E7%9A%84MGR%E9%9B%86%E7%BE%A4/</id>
    <published>2021-05-10T02:55:23.000Z</published>
    <updated>2022-01-01T14:32:15.511Z</updated>
    
    <content type="html"><![CDATA[<p>搭建一个单主模式的MGR集群</p><h1 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h1><p>实验基于MySQL8.0.24版本，操作系统为CentOS7，共三个节点，分别如下：</p><table><thead><tr><th>主机名</th><th>IP</th><th>Port</th><th>Server Id</th></tr></thead><tbody><tr><td>db156</td><td>192.168.165.156</td><td>3306</td><td>1</td></tr><tr><td>db157</td><td>192.168.165.157</td><td>3306</td><td>2</td></tr><tr><td>db225</td><td>192.168.165.225</td><td>3306</td><td>3</td></tr></tbody></table><p>架构如下：</p><p><img src="%E5%8D%95%E8%8A%82%E7%82%B9%E5%8D%95%E4%B8%BB%E7%BB%84%E5%A4%8D%E5%88%B6%E6%9E%B6%E6%9E%84.png" alt="单节点单主组复制架构"></p><h1 id="修改hosts配置"><a href="#修改hosts配置" class="headerlink" title="修改hosts配置"></a>修改hosts配置</h1><p>修改每个服务器的/etc/hosts文件并增加每个服务器的映射：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.165.156 db156</span><br><span class="line">192.168.165.157 db157</span><br><span class="line">192.168.165.225 db225</span><br></pre></td></tr></table></figure><h1 id="部署MySQL实例"><a href="#部署MySQL实例" class="headerlink" title="部署MySQL实例"></a>部署MySQL实例</h1><p>不做赘述</p><h1 id="第一个节点配置"><a href="#第一个节点配置" class="headerlink" title="第一个节点配置"></a>第一个节点配置</h1><p>修改my.cnf文件并重启MySQL服务</p><p>在mysqld下增加如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">disabled_storage_engines&#x3D;&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span><br><span class="line">server_id &#x3D; 1</span><br><span class="line">gtid_mode&#x3D;ON</span><br><span class="line">enforce_gtid_consistency&#x3D;ON</span><br><span class="line">binlog_checksum&#x3D;NONE</span><br><span class="line">log_bin &#x3D; &#x2F;data&#x2F;mysql&#x2F;logs&#x2F;mysql-bin</span><br><span class="line">log_slave_updates&#x3D;ON</span><br><span class="line">binlog_format&#x3D;ROW</span><br><span class="line">master_info_repository&#x3D;TABLE</span><br><span class="line">relay_log_info_repository&#x3D;TABLE</span><br><span class="line">transaction_write_set_extraction&#x3D;XXHASH64</span><br><span class="line">plugin_load_add&#x3D;&#39;group_replication.so&#39;</span><br><span class="line">group_replication_group_name&#x3D;&quot;1eab024d-afdd-11eb-a2d1-005056a0bb1a&quot;</span><br><span class="line">group_replication_start_on_boot&#x3D;off</span><br><span class="line">group_replication_local_address&#x3D; &quot;192.168.165.156:33061&quot;</span><br><span class="line">group_replication_group_seeds&#x3D; &quot;192.168.165.156:33061,192.168.165.157:33061,192.168.165.225:33061&quot;</span><br><span class="line">group_replication_bootstrap_group&#x3D;off</span><br></pre></td></tr></table></figure><p>重启MySQL服务后执行如下操作：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db156</span> <span class="operator">~</span>]# mysql</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">8</span></span><br><span class="line">Server version: <span class="number">8.0</span><span class="number">.24</span> MySQL Community Server <span class="operator">-</span> GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2021</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> repl@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> repl@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> BACKUP_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> repl@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE REPLICATION SOURCE <span class="keyword">TO</span> SOURCE_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, SOURCE_PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span> <span class="keyword">FOR</span> CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">2</span> warnings (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group<span class="operator">=</span><span class="keyword">ON</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> GROUP_REPLICATION <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">2.24</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group<span class="operator">=</span>OFF;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">9</span>b4c6994<span class="operator">-</span>afd5<span class="number">-11</span>eb<span class="operator">-</span>beab<span class="number">-005056</span>a0bb1a <span class="operator">|</span> db156       <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.0</span><span class="number">.24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 创建测试库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> USE test;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (c1 <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY, c2 TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;Luis&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="第二个节点配置"><a href="#第二个节点配置" class="headerlink" title="第二个节点配置"></a>第二个节点配置</h1><p>将第一个节点的配置文件复制到第二个节点并修改server-id和group_replication_local_address即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server_id &#x3D; 2</span><br><span class="line">binlog_format &#x3D; ROW</span><br><span class="line">disabled_storage_engines&#x3D;&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span><br><span class="line">gtid_mode&#x3D;ON</span><br><span class="line">enforce_gtid_consistency&#x3D;ON</span><br><span class="line">binlog_checksum&#x3D;NONE</span><br><span class="line">log_slave_updates&#x3D;ON</span><br><span class="line">master_info_repository&#x3D;TABLE</span><br><span class="line">relay_log_info_repository&#x3D;TABLE</span><br><span class="line">transaction_write_set_extraction&#x3D;XXHASH64</span><br><span class="line">plugin_load_add&#x3D;&#39;group_replication.so&#39;</span><br><span class="line">group_replication_group_name&#x3D;&quot;1eab024d-afdd-11eb-a2d1-005056a0bb1a&quot;</span><br><span class="line">group_replication_start_on_boot&#x3D;off</span><br><span class="line">group_replication_local_address&#x3D; &quot;192.168.165.157:33061&quot;</span><br><span class="line">group_replication_group_seeds&#x3D; &quot;192.168.165.156:33061,192.168.165.157:33061,192.168.165.225:33061&quot;</span><br><span class="line">group_replication_bootstrap_group&#x3D;off</span><br></pre></td></tr></table></figure><p>重启后执行如下操作，注意和第一个节点的区别：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db157</span> <span class="operator">~</span>]# mysql</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">8</span></span><br><span class="line">Server version: <span class="number">8.0</span><span class="number">.24</span> MySQL Community Server <span class="operator">-</span> GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2021</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> repl@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> repl@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> BACKUP_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> repl@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE REPLICATION SOURCE <span class="keyword">TO</span> SOURCE_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, SOURCE_PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span> <span class="keyword">FOR</span> CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">2</span> warnings (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> GROUP_REPLICATION <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">3.11</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">89999650</span><span class="operator">-</span>afd6<span class="number">-11</span>eb<span class="number">-893e-005056</span>a0d28b <span class="operator">|</span> db157       <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> RECOVERING   <span class="operator">|</span> SECONDARY   <span class="operator">|</span> <span class="number">8.0</span><span class="number">.24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">9</span>b4c6994<span class="operator">-</span>afd5<span class="number">-11</span>eb<span class="operator">-</span>beab<span class="number">-005056</span>a0bb1a <span class="operator">|</span> db156       <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.0</span><span class="number">.24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">89999650</span><span class="operator">-</span>afd6<span class="number">-11</span>eb<span class="number">-893e-005056</span>a0d28b <span class="operator">|</span> db157       <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> SECONDARY   <span class="operator">|</span> <span class="number">8.0</span><span class="number">.24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">9</span>b4c6994<span class="operator">-</span>afd5<span class="number">-11</span>eb<span class="operator">-</span>beab<span class="number">-005056</span>a0bb1a <span class="operator">|</span> db156       <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.0</span><span class="number">.24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><h1 id="第三个节点配置"><a href="#第三个节点配置" class="headerlink" title="第三个节点配置"></a>第三个节点配置</h1><p>与第二个节点相同</p>]]></content>
    
    
    <summary type="html">搭建一个单主模式的MGR集群</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="组复制" scheme="http://blog.codingcat.net/tags/%E7%BB%84%E5%A4%8D%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>MySQL组复制介绍</title>
    <link href="http://blog.codingcat.net/2021/05/07/MySQL%E7%BB%84%E5%A4%8D%E5%88%B6%E4%BB%8B%E7%BB%8D/"/>
    <id>http://blog.codingcat.net/2021/05/07/MySQL%E7%BB%84%E5%A4%8D%E5%88%B6%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-05-07T07:39:13.000Z</published>
    <updated>2022-01-01T14:32:15.496Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍MySQL组复制相关知识，包括原理及相关的服务。</p><h1 id="什么是MySQL组复制"><a href="#什么是MySQL组复制" class="headerlink" title="什么是MySQL组复制"></a>什么是MySQL组复制</h1><p>MySQL Group Replication（MGR）是MySQL 5.7.17引入的服务器插件，可用来创建弹性的、高可用的、容错的复制集群，保证数据库服务持续可用。MGR提供节点之间抢协调性的分布式状态复制，节点间可以自动协调。 MGR可以是单主模式（同一时间只有一个节点接受写操作，且主节点有系统自动选择），多主模式（所有的节点都可接受写操作，即使是同时发送的）两种模式。</p><p>MGR内置的组员服务会保持组内所有节点之间的视图的一致性及可用性供所有节点使用，节点加入或者退出时，视图会相应更新，当某个节点故障时，故障检测机制会检测到并通知组其视图已经发生变更，这些都是自动完成的。</p><p>对于要提交的事务，组内大多数成员需按照全局事务ID的事务顺序达成一致才能提交，提交或者回滚的事务均有每个节点单独完成，但是所有的节点必须做出相同的决定。如果存在网络分区，导致成员无法达成一致，则系统在问题解决前不会继续执行。这是系统内置的自动保护脑裂的机制。</p><p>MGR是基于Group Communication System（GCS）协议的，该协议提供了故障检测机制，组员服务以及安全完整的消息传递服务，这些服务确保了数据在组内复制中的一致性，是创建复制系统的关键，而核心的技术是基于Paxos算法的实现，是组通信的引擎。</p><h1 id="MySQL复制技术"><a href="#MySQL复制技术" class="headerlink" title="MySQL复制技术"></a>MySQL复制技术</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>传统MySQL复制提供的是基于一个源数据库即主节点并复制到一个或多个从节点的复制，主节点应用事务并提交，然后将对数据库的更改发送到从节点上去执行（基于语句的复制）或者是应用（基于行的复制）。默认情况下，所有的节点都包含了一个与主库完全相同的数据，属于shared-nothing的方案。</p><p>如下是MySQL异步复制原理</p><p><img src="%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png" alt="异步复制原理"></p><p>如下是MySQL半同步复制原理</p><p><img src="%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png" alt="半同步复制原理"></p><p>其中，在各个实例之间的箭头表示实例之间的数据交换以及实例和客户端应用程序之间的数据交换。异步复制和半同步复制的区别在于，半同步复制需要等待至少一个从库复制并应用了中继日志收到回应（有一个等待时间，超过这个时间没有收到回应则退化为异步复制）之后再提交，提高主从数据一致性。而异步复制无需等待从库确认，最大化性能。</p><h2 id="组复制"><a href="#组复制" class="headerlink" title="组复制"></a>组复制</h2><p>组复制是可以用来实现容错系统的技术。复制组是一个服务组，其中的每个服务拥有整个数据的副本，每个服务之间通过消息交流。通信层保证院子消息的传递以及顺序。MGR在此基础上构建并实现了多主更新协议。组内的每个服务独立执行事务，但是每个读写事务均是在组同意后提交，也就是有组来决定是否提交每个读写事务，因此提交操作并非原始服务单方面决定的。读事务不需要组内同意就可以立即提交。</p><p>当读写事务在原始服务上准备提交时，服务会先自动将修改的行以及相应的主键广播。由于事务是按照原子广播的，所有的服务，要么都收到事务要么都没有收到。如果接受到，那都是以同样的顺序接受到并且为这个事务建立起一个全局的顺序。在不同服务上同时执行的事务可能会发生冲突，如两个服务上同时对同一行数据进行修改。解决冲突的方法是顺序在前的事务先提交，顺序在后的事务在原始服务上回滚并从组内其他服务中删除。</p><p><img src="%E7%BB%84%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png" alt="组复制原理"></p><p>组复制也是一种shared-nothing的方案，其中每个成员都有自己完整的数据副本。</p><h1 id="组复制应用场景"><a href="#组复制应用场景" class="headerlink" title="组复制应用场景"></a>组复制应用场景</h1><ul><li>弹性复制：服务的数量可以动态添加和减少且尽可能的减少对原服务的影响，如云数据库服务</li><li>高可用分片：分片是写扩展的流行解决方案，使用MGR来实现高可用分片，每个分片映射到一个复制组。</li><li>主从复制替代方案：某些情况下，使用单主服务可能会使其成为连接热点，使用多主会更具扩展性。</li></ul><h1 id="组复制相关服务"><a href="#组复制相关服务" class="headerlink" title="组复制相关服务"></a>组复制相关服务</h1><h2 id="组员服务"><a href="#组员服务" class="headerlink" title="组员服务"></a>组员服务</h2><p>在MGR中，一组服务组成一个复制组。有组名，组时动态的，服务可以在任何时候加入或者离开，组会自动调整。如果有服务加入组，则会从已有的服务中将丢失的状态同步至最新。如果有服务离开，则其余的服务会重新配置组。组员服务定义了哪些服务是在线的并参与到组的，在线的服务列表通常是一个视图。组内的每个服务都有一个一致性视图，说明哪些服务是此刻参与到组复制的成员。组成员不仅仅要统一提交事务，还要统一当前的视图是哪一个如果已有的成员同意新的服务加入称为组的一部分，则组会重新配置，引发视图变更。如果服务离开（自愿与否），组会动态重新配置并引发视图变更。当组员自动离开时，不需要经过大多数成员的同意即可进行重新配置。如果是被动离开如宕机、断网，组复制故障检测机制检测到之后，需要组内成员协商，大部分成员同意之后才能重新配置。</p><h2 id="故障检测服务"><a href="#故障检测服务" class="headerlink" title="故障检测服务"></a>故障检测服务</h2><p>组复制包含了故障检测机制，能够发现并报告那个服务是已经不可用了。当服务A在一段时间内无法接收到服务B的消息并引发超时，会怀疑服务B异常，如果组内其他成员也同意此怀疑，则会将服务B认为是异常的并将该服务排除在组外。当一个服务与所有其他组都无法通信时，会怀疑自己异常，但是因为无法通过协商与组达成一致，因此该怀疑不会产生结果。</p><h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>MGR是建立在Paxos分布式算法的实现上，用来在服务之间进行分布式协商决策，因此需要大多数服务处于活动状态达到法定票数才能做决策。这直接影响了系统中能够出错而不影响整体功能的服务个数，设能够允许出错的服务个数为f，则总服务n=2*f+1. 在实际应用中，允许一个服务故障则需要有3个服务，当一个服务故障时，仍然有两个服务来组成大多数票数并允许系统继续自动决策，但是如果有两个服务故障，则复制组阻塞，一个服务无法组成大多数的票数来做决策。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>作为MySQL众多高可用集群中的一种，MGR不需要额外的安装其他插件即可提供高可用、可扩展等特性，但是，当故障转移时，应用程序需要修改IP到新的主所在的服务器。MGR从5.7退出以来备受关注，如今发展到8.0版本，功能不断完善，市场上也有部分企业开始使用MGR上生产，这是未来的一个趋势。</p>]]></content>
    
    
    <summary type="html">本文主要介绍MySQL组复制相关知识，包括原理及相关的服务。</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="组复制" scheme="http://blog.codingcat.net/tags/%E7%BB%84%E5%A4%8D%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>MySQL主从复制原理</title>
    <link href="http://blog.codingcat.net/2021/04/06/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/"/>
    <id>http://blog.codingcat.net/2021/04/06/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/</id>
    <published>2021-04-06T07:53:34.000Z</published>
    <updated>2022-01-01T14:32:15.491Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要尝试说明MySQL主从复制的原理。</p><h2 id="什么是主从复制？"><a href="#什么是主从复制？" class="headerlink" title="什么是主从复制？"></a>什么是主从复制？</h2><p>主从复制指的是数据库在运行过程中，将数据从主库复制到从库的过程，可以从一主复制到一个或多个从库。可以采用异步复制、半同步复制方式。有基于日志点的复制和基于GTID（global transaction id：全局事务ID）的复制两种形式。将数据复制到从库，以达到高可用、高性能的目的。</p><h2 id="为什么要用主从复制？"><a href="#为什么要用主从复制？" class="headerlink" title="为什么要用主从复制？"></a>为什么要用主从复制？</h2><ol><li><p>高可用</p><p>当主库宕机或者主库需要做升级的时候，可以将主库切换到从库上，新的主库对外提供服务，保证服务可用，同时也可以对主库完成运维操作。</p></li><li><p>高性能</p><p>大多数互联网业务读数据操作较多，可以采用多个从库，将读操作由从库进行，每个从库进行不同类型的读操作，而主库只进行写操作，从而提升数据库的整体性能。</p></li><li><p>数据备份</p><p>可以使用从库的方式对数据库进行备份</p></li></ol><h2 id="主从复制有什么优缺点"><a href="#主从复制有什么优缺点" class="headerlink" title="主从复制有什么优缺点"></a>主从复制有什么优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>可扩展：在读压力大的情况下，可以增加多个读节点，将读数据操作分发到不同的节点减轻读压力</li><li>高性能：因为数据分发到不同的节点执行，每个服务器上的压力减小，性能得到提升</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>一致性问题：主要有主从延迟导致的数据不一致和双写导致的数据不一致两种。一致性问题有很多解决方案，如全局唯一ID生成器、双主情况下的间隔ID自增策略</li><li>延时问题：从库监听主库数据变化再复制到从库执行这个过程是需要时间的，因此从库一般和主库之间都会存在延时问题，且随着从库数量的增加，复制压力增加，主从复制的延时也会增加</li></ul><h2 id="MySQL主从复制原理"><a href="#MySQL主从复制原理" class="headerlink" title="MySQL主从复制原理"></a>MySQL主从复制原理</h2><p>MySQL主从复制的基础是binlog（二进制日志），binlog记录了数据库中数据的变化，只有启用了binlog才能配置主从复制。</p><ol><li>业务端在对主库操作时将会将操作的内容写入到binlog中</li><li>主库为每个从库创建一个log dump线程，读取和发送binlog中的内容</li><li>当从库建立和主库的连接之后，从节点会创建一个IO线程，用来请求主库中更新了的binlog，在接收了主节点中log dump线程发送的更新之后，将更新写入到从节点的relay log（中继日志）中</li><li>在接收到主库的变更之后，从库SQL线程读取relay log中的记录，解析为数据库的操作，并将操作应用到数据库，保证主库和从库的一致性。</li></ol><p><img src="MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png" alt="MySQL主从复制原理"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要描述了MySQL数据库主从复制优缺点及原理。MySQL数据库在互联网行业使用广泛，且具有高性能可扩展等特点，在近些年来发展相当迅速。虽然和Oracle RAC实时集群相比，做到双写双活有一定限制，但是对于大多数场景也足够使用了。</p>]]></content>
    
    
    <summary type="html">本文主要尝试说明MySQL主从复制的原理。</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>如何写好一篇技术文章</title>
    <link href="http://blog.codingcat.net/2021/03/27/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%80%E7%AF%87%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"/>
    <id>http://blog.codingcat.net/2021/03/27/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%80%E7%AF%87%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/</id>
    <published>2021-03-27T02:36:03.000Z</published>
    <updated>2022-01-01T14:32:15.508Z</updated>
    
    <content type="html"><![CDATA[<p>本文仅一张脑图，由 <a href="https://www.jianshu.com/p/77aeb135e5d1">https://www.jianshu.com/p/77aeb135e5d1</a> 总结而来。本文仅一张脑图，由 <a href="https://www.jianshu.com/p/77aeb135e5d1">https://www.jianshu.com/p/77aeb135e5d1</a> 总结而来。</p><p><img src="%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%80%E7%AF%87%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0.png" alt="如何写好一篇技术文章"></p><p>详细的内容请移步 <a href="https://www.jianshu.com/p/77aeb135e5d1">https://www.jianshu.com/p/77aeb135e5d1</a> 。</p><p>文中的参考地址 <a href="https://github.com/ruanyf/document-style-guide">https://github.com/ruanyf/document-style-guide</a> 中的内容也不错。</p>]]></content>
    
    
    <summary type="html">本文仅一张脑图，由 https://www.jianshu.com/p/77aeb135e5d1 总结而来。本文仅一张脑图，由 https://www.jianshu.com/p/77aeb135e5d1 总结而来。</summary>
    
    
    
    <category term="技术文章" scheme="http://blog.codingcat.net/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"/>
    
    
    <category term="技术文章" scheme="http://blog.codingcat.net/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/"/>
    
  </entry>
  
  <entry>
    <title>MySQL8.0 OCP大纲</title>
    <link href="http://blog.codingcat.net/2021/03/06/MySQL8-0-OCP%E5%A4%A7%E7%BA%B2/"/>
    <id>http://blog.codingcat.net/2021/03/06/MySQL8-0-OCP%E5%A4%A7%E7%BA%B2/</id>
    <published>2021-03-06T03:14:15.000Z</published>
    <updated>2022-01-01T14:32:15.490Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要列举MySQL8.0 OCP考点</p><h3 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h3><ul><li>配置客户端到服务器的连接</li><li>了解MySQL如何存储数据</li><li>了解InnoDB如何存储数据和日志</li><li>配置缓冲区和缓存</li><li>了解和使用数据字典</li></ul><h3 id="服务器安装和配置"><a href="#服务器安装和配置" class="headerlink" title="服务器安装和配置"></a>服务器安装和配置</h3><p>安装和使用MySQL服务器和客户端程序<br>识别在安装过程中创建的文件和文件夹<br>启动和停止MySQL<br>升级MySQL<br>使用选项和选项文件配置MySQL<br>配置MySQL变量<br>在同一主机上启动多个MySQL服务器</p><h3 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h3><ul><li>创建用户帐户和角色</li><li>使用身份验证插件</li><li>控制用户和角色权限</li><li>认识常见的安全风险</li><li>安全的MySQL服务器连接</li><li>提供密码和登录安全性</li><li>保护MySQL主机环境</li><li>防止SQL注入攻击</li><li>加密MySQL资料</li><li>配置MySQL企业防火墙</li></ul><h3 id="监控与维护"><a href="#监控与维护" class="headerlink" title="监控与维护"></a>监控与维护</h3><ul><li>配置和查看MySQL日志文件</li><li>监控MySQL进程和状态</li><li>配置MySQL企业审核</li><li>使用MySQL Enterprise Monitor查看MySQL中的活动</li><li>监控数据库增长并解释容量计划</li><li>解决资源锁定问题</li></ul><h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><ul><li>检查MySQL如何优化查询</li><li>使用MySQL Enterprise Monitor分析查询</li><li>创建索引以提高服务器性能</li><li>监视和了解索引统计信息</li></ul><h3 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h3><p>区分不同类型的备份<br>实施备份策略<br>使用MySQL Enterprise Backup备份和还原数据<br>使用mysqldump和mysqlpump执行逻辑备份<br>说明何时以及如何使用原始文件备份<br>备份二进制日志</p><h3 id="高可用性技术"><a href="#高可用性技术" class="headerlink" title="高可用性技术"></a>高可用性技术</h3><p>说明复制如何提供高可用性和可伸缩性<br>配置复制<br>解释二进制日志在复制中的作用<br>配置多源复制<br>解释复制线程的作用<br>监控复制并排除故障<br>描述MySQL InnoDB集群和组复制<br>配置一个MySQL InnoDB集群<br>执行InnoDB集群恢复</p>]]></content>
    
    
    <summary type="html">本文主要列举MySQL8.0 OCP考点</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="OCP" scheme="http://blog.codingcat.net/tags/OCP/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7下如何设置MySQL开机自启</title>
    <link href="http://blog.codingcat.net/2020/12/29/CentOS7%E4%B8%8B%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AEMySQL%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/"/>
    <id>http://blog.codingcat.net/2020/12/29/CentOS7%E4%B8%8B%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AEMySQL%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/</id>
    <published>2020-12-28T16:00:00.000Z</published>
    <updated>2022-01-01T14:32:15.473Z</updated>
    
    <content type="html"><![CDATA[<p>一般在部署完MySQL的时候都需要设置开机启动，本文讲解CentOS7下如何配置MySQL开机自启。</p><p>CentOS7和6及以前的版本不一样，下面推荐使用systemctl命令来管理服务而不是以前的service(虽然service还能用)，废话不多说，直接看怎么做吧</p><h3 id="创建服务文件"><a href="#创建服务文件" class="headerlink" title="创建服务文件"></a>创建服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /usr/lib/systemd/system/mysqld.service</span><br></pre></td></tr></table></figure><p>mysqld是服务的名字，可自定义，不过必须以.service结尾。</p><p>服务文件内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">ExecStart=/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE = 5000</span><br></pre></td></tr></table></figure><p>内容还是通俗易懂的，就不细说啦，需要注意的是ExecStart是启动MySQL的脚本，这里需要使用mysqld文件来启动，而不是使用service命令时的support-files/mysql.server，这里有个好处就是，在多实例又不想使用MySQL官方自带的mysqlmulti的时候，就很方便。</p><h3 id="配置开机自启"><a href="#配置开机自启" class="headerlink" title="配置开机自启"></a>配置开机自启</h3><p>创建好服务文件之后，开机自启就简单了，一条命令即可：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysqld</span><br></pre></td></tr></table></figure><p>同时还可以使用systemctl命令启停MySQL实例，是不是很方便呀，赶紧试试吧！</p>]]></content>
    
    
    <summary type="html">一般在部署完MySQL的时候都需要设置开机启动，本文讲解CentOS7下如何配置MySQL开机自启。</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>SQL注入介绍</title>
    <link href="http://blog.codingcat.net/2020/12/05/SQL%E6%B3%A8%E5%85%A5%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%A2%84%E9%98%B2/"/>
    <id>http://blog.codingcat.net/2020/12/05/SQL%E6%B3%A8%E5%85%A5%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%A2%84%E9%98%B2/</id>
    <published>2020-12-04T16:00:00.000Z</published>
    <updated>2022-01-01T14:32:15.501Z</updated>
    
    <content type="html"><![CDATA[<p>SQL 注入攻击是通过将恶意的SQL语句如添加、删除等插入到应用的输入参数中，经过后台解析后发送到数据库服务器上解析执行进行的攻击。本文以mysql为例，讨论SQL注入以及在Django中如何防止SQL注入。</p><h2 id="SQL注入介绍"><a href="#SQL注入介绍" class="headerlink" title="SQL注入介绍"></a>SQL注入介绍</h2><p>在Web程序中，一般都会有后台根据用户输入内容查找或者执行相关动作的场景，如登录时查询用户是否存在。后台在处理的时候可能是根据用户输入的用户名，拼接SQL之后到数据库查询来判断，这时，如果用户恶意输入不正确内容或内容本身存在问题，会导致应用程序崩溃，甚至是丢失数据等导致相关损失。即通过把SQL命令插入到Web表单提交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。这种场景就称为SQL注入。</p><h3 id="一个SQL注入的简单例子"><a href="#一个SQL注入的简单例子" class="headerlink" title="一个SQL注入的简单例子"></a>一个SQL注入的简单例子</h3><p>如执行一条SQL语句:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line">  <span class="keyword">from</span> tb_user </span><br><span class="line"> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;jacobzhou&#x27;</span>;</span><br></pre></td></tr></table></figure><p>其中jacobzhou是用户输入的值，此时可以得到正确的值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   <span class="keyword">from</span> tb_user </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;jacobzhou&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+----------+------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> username  <span class="operator">|</span> password <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+----------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> jacobzhou <span class="operator">|</span> <span class="number">123456</span>   <span class="operator">|</span>   <span class="number">29</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-----------+----------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>但是，当用户输入错误的值，如jacobzhou’;drop table  tb_test;，如果使用的是字符串拼接的方式去执行，SQL语句就变成了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * </span><br><span class="line">  from tb_user </span><br><span class="line"> where username &#x3D; &#39;jacobzhou&#39;;drop table tb_test;&#39;;</span><br></pre></td></tr></table></figure><p>执行结果为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   <span class="keyword">from</span> tb_user </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;jacobzhou&#x27;</span>;<span class="keyword">drop</span> <span class="keyword">table</span> tb_test;<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">+------+-----------+----------+------+</span></span><br><span class="line"><span class="string">| id   | username  | password | age  |</span></span><br><span class="line"><span class="string">+------+-----------+----------+------+</span></span><br><span class="line"><span class="string">|    1 | jacobzhou | 123456   |   29 |</span></span><br><span class="line"><span class="string">+------+-----------+----------+------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ERROR 1051 (42S02): Unknown table &#x27;</span>db<span class="operator">-</span>platform.tb_test<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><p>以上就是一个SQL注入的例子，可以看到，如果db-platform.tb_test表存在，那就会被恶意删除。例子相对较极端，对于Django自带的connection来说，使用execute函数执行SQL语句的时候，每次只执行一条语句，后一条语句不会执行。因此上面的例子在Django中是不成立的，但是足以说明SQL注入所带来的安全风险。那SQL注入都有哪些方式，如何才能防止SQL注入呢？</p><h2 id="SQL注入原理"><a href="#SQL注入原理" class="headerlink" title="SQL注入原理"></a>SQL注入原理</h2><p>Web应用程序对于用户输入的数据和合法性没有严谨的判断，前端用户的输入直接传输给后端，攻击者通过构造不同的参数，形成不同的SQL语句来实现对数据库的任意操作。<br>SQL注入产生需要满足两个条件：</p><ul><li>参数用户可控：前端传给后端的参数内容是用户可以控制的</li><li>参数带入数据库查询：传入的参数直接拼接到SQL语句，且带入数据库查询</li></ul><h2 id="SQL注入类型"><a href="#SQL注入类型" class="headerlink" title="SQL注入类型"></a>SQL注入类型</h2><p>SQL注入的分类有很多，如POST注入、Cookie注入、延时注入、搜索注入等，但是归根结底也是数字型和字符型注入的不同展现形式或者是注入的位置不同。</p><h3 id="数字型"><a href="#数字型" class="headerlink" title="数字型"></a>数字型</h3><p>用户输入为整数，假设SQL语句为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> home_application_database <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>; </span><br></pre></td></tr></table></figure><p>其中3为数字，是用户正常输入。</p><p>当满足如下条件，则可能存在数字型注入：</p><ul><li>输入3’ 页面报错（SQL语法错误）</li><li>输入3 and 1 = 1 页面正常返回结果</li><li>输入3 and 1=2 页面返回错误（SQL语句返回空数据）</li></ul><p>如果后台使用的是<code>select * from home_application_database where id = </code>和未经验证的用户输入做拼接后去数据库查询，就满足了上面的三个条件，存在数字型注入。</p><p>这里可以看到用户输入必须是整数，后端验证用户输入必须是整数才会继续执行即可解决。</p><h3 id="字符型"><a href="#字符型" class="headerlink" title="字符型"></a>字符型</h3><p>用户输入是字符串，如SQL语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> home_application_database <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;154&#x27;</span></span><br></pre></td></tr></table></figure><p>其中154是字符串，是用户正常输入。</p><p>当满足如下条件时，则可能存在字符型注入：</p><ul><li>输入154’，页面异常（SQL语句语法错误）</li><li>输入154’ and 1 = 1 – ，页面正常返回</li><li>输入154’ and 1 = 2 – ，页面错误（查询结果为空）</li></ul><p>同数字型，如果后台直接使用拼接语句的形式去数据库执行，则就满足了上面单个条件，存在字符型注入。攻击者使用单引号的方式提前结束前一个单引号，并使用and来添加其他操作。</p><h2 id="如何防止SQL注入"><a href="#如何防止SQL注入" class="headerlink" title="如何防止SQL注入"></a>如何防止SQL注入</h2><p>在开发时应该秉持一种<strong>外部参数皆不可信</strong>的原则来进行开发。</p><ul><li><p>加强参数验证</p><p>开发时，验证所有来自前端的输入，必须是符合要求的数据类型，符合指定规则的数据才允许继续往下执行。</p></li><li><p>SQL语句参数化处理</p><p>减少使用或不使用字符串拼接的方式执行SQL，而是将用户输入当着参数传给执行SQL的方法，如Django中的cursor.execute()函数就支持在SQL语句中使用占位符，将输入作为参数传递给方法执行。</p></li><li><p>存储过程</p><p>使用存储过程也可以有效防止SQL注入，不过在存储过程中，需使用占位符，并且使用输入参数来预编译SQL语句后再执行。</p></li></ul><h2 id="Django中防止SQL注入"><a href="#Django中防止SQL注入" class="headerlink" title="Django中防止SQL注入"></a>Django中防止SQL注入</h2><p>Django中使用ORM可以有效防止SQL注入，所以应该尽可能使用ORM。但是ORM对于复杂查询就无能为力了，这时就需要执行原生SQL时，可以使用如下方式：</p><ol><li>使用extra（不建议使用这种方式执行SQL）</li><li>使用raw</li><li>使用django.db执行自定义SQL</li><li>直接使用pymysql</li></ol><p>在使用原生SQL语句时，应避免直接使用用户输入拼接SQL语句，上面三种执行原生SQL的方式均提供了占位符来进行参数替换，防止SQL注入。我们比较常用的是3、和4，两种方法都是使用cursor.execue()方法，具体如下：</p><ul><li><p>django.db</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line">cursor = connection.cursor()</span><br><span class="line">cursor.execute(sql)</span><br><span class="line">result = cursor.fetchall()</span><br></pre></td></tr></table></figure></li><li><p>pymysql</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection = pymysql.connect(**mysql_server)</span><br><span class="line">cursor = connection.cursor()</span><br><span class="line">cursor.execute(sql)</span><br><span class="line">result = cursor.fetchall()</span><br></pre></td></tr></table></figure><p>execute中的sql语句使用占位符，并传入相应参数即可防止SQL注入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sql&#x3D;&quot;select * from home_application_database where id &#x3D; %s&quot; </span><br><span class="line">cursor.execute(sql,3)</span><br><span class="line">1</span><br><span class="line">cursor.execute(sql,&quot;3&#39;&quot;)</span><br><span class="line">1</span><br><span class="line">E:\venv\python2\lib\site-packages\pymysql\cursors.py:297: Warning: Truncated incorrect DOUBLE value: &#39;3&#39;&#39;</span><br><span class="line">  self._do_get_result()</span><br><span class="line">cursor.execute(sql,&quot;3 and 1 &#x3D; 1 &quot;)</span><br><span class="line">E:\venv\python2\lib\site-packages\pymysql\cursors.py:297: Warning: Truncated incorrect DOUBLE value: &#39;3 and 1 &#x3D; 1 &#39;</span><br><span class="line">1</span><br><span class="line">  self._do_get_result()</span><br><span class="line">cursor.execute(sql,&quot;3 and 1 &#x3D; 2 &quot;)</span><br><span class="line">E:\venv\python2\lib\site-packages\pymysql\cursors.py:297: Warning: Truncated incorrect DOUBLE value: &#39;3 and 1 &#x3D; 2 &#39;</span><br><span class="line">  self._do_get_result()</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>从上面执行结果看出，对于整数型注入，使用execute中带参数执行的方式，并不满足注入条件，当使用3’，3 and 1 = 1 ，3 and 1 = 2 作为输入传给execute执行时，程序报错。</p><p>同理对于字符型注入也一样。</p><blockquote><p>注意：在使用execute函数执行时，SQL语句中的占位符，不管是字符还是整型，都使用%s，且对于字符型的数据，在SQL语句里面不能使用’%s’，否则会报错。使用参数替换本质上是对输入的参数进行转义处理，防止输入中的引号。</p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">SQL 注入攻击是通过将恶意的SQL语句如添加、删除等插入到应用的输入参数中，经过后台解析后发送到数据库服务器上解析执行进行的攻击。本文以mysql为例，讨论SQL注入以及在Django中如何防止SQL注入。</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
    <category term="SQL注入" scheme="http://blog.codingcat.net/tags/SQL%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>MySQL忘记root密码怎么办</title>
    <link href="http://blog.codingcat.net/2020/10/23/MySQL%E5%BF%98%E8%AE%B0root%E5%AF%86%E7%A0%81%E6%80%8E%E4%B9%88%E5%8A%9E/"/>
    <id>http://blog.codingcat.net/2020/10/23/MySQL%E5%BF%98%E8%AE%B0root%E5%AF%86%E7%A0%81%E6%80%8E%E4%B9%88%E5%8A%9E/</id>
    <published>2020-10-22T16:00:00.000Z</published>
    <updated>2022-01-01T14:32:15.493Z</updated>
    
    <content type="html"><![CDATA[<p>使用MySQL过程中我们偶尔会遇到忘记密码的情况，怎么办呢？能不能吧密码找回来或者重新设置密码呢？</p><p>MySQL忘记root密码之后，可以重新设置一个新的密码，怎么做呢？</p><ol><li><p>修改配置文件my.cnf，在[mysqld]下面增加参数：skip-grant-tables（启动 MySQL 服务的时候跳过权限表认证。启动后，连接到 MySQL 的 root 将不需要口令。），重启MySQL服务，免密码登录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ocp11g~]# vi &#x2F;etc&#x2F;my.cnf    </span><br><span class="line">[root@ocp11g~]# service mysql restart</span><br><span class="line">Shuttingdown MySQL.... SUCCESS!</span><br><span class="line">StartingMySQL.. SUCCESS!</span><br><span class="line">[root@ocp11g~]# mysql -uroot</span><br><span class="line">Welcometo the MySQL monitor. Commands end with; or \g.</span><br><span class="line">YourMySQL connection id is 2</span><br><span class="line">Serverversion: 5.7.26-log MySQL Community Server (GPL)</span><br><span class="line">Copyright(c) 2000, 2019, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line">Oracleis a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates.Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type&#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></li><li><p>修改root用户密码为空</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;alter user root@localhost identified by &#39;123456&#39;;</span><br><span class="line">ERROR1290 (HY000): The MySQL server is running with the --skip-grant-tables optionso it cannot execute this statement</span><br><span class="line">mysql&gt;update user set authentication_string &#x3D; NULL where user &#x3D; &#39;root&#39;;</span><br><span class="line">ERROR1046 (3D000): No database selected</span><br><span class="line">mysql&gt;use mysql</span><br><span class="line">Readingtable information for completion of table and column names</span><br><span class="line">Youcan turn off this feature to get a quicker startup with -A</span><br><span class="line">Databasechanged</span><br><span class="line">mysql&gt;update user set authentication_string &#x3D; NULL where user &#x3D; &#39;root&#39;;</span><br><span class="line">QueryOK, 1 row affected (0.01 sec)</span><br><span class="line">Rowsmatched: 1 Changed: 1 Warnings: 0</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></li><li><p>修该配置文件删除skip-grant-tables参数，重启MySQL服务，使用空密码登录，修改root密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ocp11g~]# vi &#x2F;etc&#x2F;my.cnf    </span><br><span class="line">[root@ocp11g~]# service mysql restart</span><br><span class="line">Shuttingdown MySQL.. SUCCESS!</span><br><span class="line">StartingMySQL. SUCCESS!</span><br><span class="line">[root@ocp11g~]# mysql -uroot</span><br><span class="line">Welcometo the MySQL monitor. Commands end with; or \g.</span><br><span class="line">YourMySQL connection id is 3</span><br><span class="line">Serverversion: 5.7.26-log MySQL Community Server (GPL)</span><br><span class="line">Copyright(c) 2000, 2019, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line">Oracleis a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates.Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type&#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line">mysql&gt;alter user root@localhost identified by &#39;123456&#39;;</span><br><span class="line">QueryOK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></li><li><p>密码修改完成，MySQL root密码已修改，MySQL正常使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ocp11g~]# mysql -uroot</span><br><span class="line">ERROR1045 (28000): Access denied for user &#39;root&#39;@&#39;localhost&#39; (using password: NO)</span><br><span class="line">[root@ocp11g~]# mysql -uroot -p</span><br><span class="line">Enterpassword:</span><br><span class="line">Welcometo the MySQL monitor. Commands end with; or \g.</span><br><span class="line">YourMySQL connection id is 5</span><br><span class="line">Serverversion: 5.7.26-log MySQL Community Server (GPL)</span><br><span class="line">Copyright(c) 2000, 2019, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line">Oracleis a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates.Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type&#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line">mysql&gt;exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">使用MySQL过程中我们偶尔会遇到忘记密码的情况，怎么办呢？能不能吧密码找回来或者重新设置密码呢？</summary>
    
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://blog.codingcat.net/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Oracle数据库关闭的情况下如何修改参数</title>
    <link href="http://blog.codingcat.net/2020/10/20/Oracle%E5%85%B3%E9%97%AD%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0/"/>
    <id>http://blog.codingcat.net/2020/10/20/Oracle%E5%85%B3%E9%97%AD%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0/</id>
    <published>2020-10-19T16:00:00.000Z</published>
    <updated>2022-01-01T14:32:15.498Z</updated>
    
    <content type="html"><![CDATA[<p>很多时候由于误操作，修改了某些参数后，重启数据库发现无法启动，需要将参数修改回来或者其他操作后才能正常启动，但是在数据库关闭的情况下，无法使用alter system等命令来修改参数，到底需要怎么做呢？</p><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在Oracle中很多参数在修改的时候都有一定的规定，如在设置快速恢复区时，db_recovery_file_dest和db_recovery_file_dest_size需修改后重启数据库，如果只修改了db_recovery_file_dest，db_recovery_file_dest_size并不设定值，则无法重启数据库，启动时报错如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; startup </span><br><span class="line">ORA-19802: cannot use DB_RECOVERY_FILE_DEST without DB_RECOVERY_FILE_DEST_SIZE</span><br></pre></td></tr></table></figure><p>由于数据库已关闭，这时候也无法修改参数db_recovery_file_dest_size：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter system set db_recovery_file_dest_size&#x3D;4G scope&#x3D;spfile;</span><br><span class="line">alter system set db_recovery_file_dest_size&#x3D;4G scope&#x3D;spfile</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01034: ORACLE not available</span><br><span class="line">Process ID: 0</span><br><span class="line">Session ID: 0 Serial number: 0</span><br></pre></td></tr></table></figure><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>遇到上面类似修改参数之后无法启动数据库的情况，可以通过修改参数文件来解决。在Oracle中，有spfile和pfile两种参数文件，spfile是不可编辑的，正常情况下数据库使用的是spfile，pfile可以编辑，Oracle中可以通过spfile和pfile来相互创建，因此可以通过这个方法来解决此问题。</p><p>首先，使用已有的pfile来启动数据库，如果没有，可以根据其他数据库的内容来手动创建：startup pfile=’’</p><p>启动后，使用create pfile=’新的pfile文件’ from spfile=’原来的spfile文件’，此时的数据库状态不一定非得OPEN。</p><p>然后修改新建的pfile文件，确保参数都正确修改，如上面的例子，删除db_recovery_file_dest所在的行</p><p>关闭数据库并使用新的pfile文件启动数据库：startup pfile=’新的pfile’;</p><p>创建spfile文件：create spfile=’spfile文件’ from pfile=’新的pfile文件’;</p><p>关闭数据库，正常启动：startup</p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; show parameter db_recovery            </span><br><span class="line"></span><br><span class="line">NAME                                 TYPE        VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_recovery_file_dest                string</span><br><span class="line">db_recovery_file_dest_size           big integer 0</span><br><span class="line">SQL&gt; alter system set db_recovery_file_dest&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;fast_recovery_area&#39; scope&#x3D;spfile;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line">SQL&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">SQL&gt; startup </span><br><span class="line">ORA-19802: cannot use DB_RECOVERY_FILE_DEST without DB_RECOVERY_FILE_DEST_SIZE</span><br><span class="line">SQL&gt; alter system set db_recovery_file_dest_size&#x3D;4G scope&#x3D;spfile;</span><br><span class="line">alter system set db_recovery_file_dest_size&#x3D;4G scope&#x3D;spfile</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01034: ORACLE not available</span><br><span class="line">Process ID: 0</span><br><span class="line">Session ID: 0 Serial number: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; startup pfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;init.ora&#39;</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1073737800 bytes</span><br><span class="line">Fixed Size                  8904776 bytes</span><br><span class="line">Variable Size             616562688 bytes</span><br><span class="line">Database Buffers          440401920 bytes</span><br><span class="line">Redo Buffers                7868416 bytes</span><br><span class="line">ORA-00205: error in identifying control file, check alert log for more info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; select status from v$instance;</span><br><span class="line"></span><br><span class="line">STATUS</span><br><span class="line">------------</span><br><span class="line">STARTED</span><br><span class="line"></span><br><span class="line">SQL&gt; create pfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;init-20201020.ora&#39; from spfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;spfileorcl.ora&#39;;</span><br><span class="line"></span><br><span class="line">File created.</span><br><span class="line"></span><br><span class="line">SQL&gt; shutdown immediate </span><br><span class="line">ORA-01507: database not mounted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">SQL&gt; </span><br></pre></td></tr></table></figure><p>修改文件/u01/app/oracle/product/19.3.0/db_1/dbs/init-20201020.ora，删除db_recovery_file_dest所在的行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; startup pfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;init-20201020.ora&#39;</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1593832624 bytes</span><br><span class="line">Fixed Size                  9135280 bytes</span><br><span class="line">Variable Size             973078528 bytes</span><br><span class="line">Database Buffers          603979776 bytes</span><br><span class="line">Redo Buffers                7639040 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br><span class="line"></span><br><span class="line">SQL&gt; create spfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;spfileorcl.ora&#39; from pfile&#x3D;&#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;19.3.0&#x2F;db_1&#x2F;dbs&#x2F;init-20201020.ora&#39;;</span><br><span class="line"></span><br><span class="line">File created.</span><br><span class="line"></span><br><span class="line">SQL&gt; </span><br><span class="line">SQL&gt; shutdown immediate </span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">SQL&gt; startup </span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1593832624 bytes</span><br><span class="line">Fixed Size                  9135280 bytes</span><br><span class="line">Variable Size             973078528 bytes</span><br><span class="line">Database Buffers          603979776 bytes</span><br><span class="line">Redo Buffers                7639040 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">很多时候由于误操作，修改了某些参数后，重启数据库发现无法启动，需要将参数修改回来或者其他操作后才能正常启动，但是在数据库关闭的情况下，无法使用alter system等命令来修改参数，到底需要怎么做呢？</summary>
    
    
    
    <category term="Oracle" scheme="http://blog.codingcat.net/categories/Oracle/"/>
    
    
    <category term="Oracle" scheme="http://blog.codingcat.net/tags/Oracle/"/>
    
  </entry>
  
</feed>
